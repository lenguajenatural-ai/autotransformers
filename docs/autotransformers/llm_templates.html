<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>autotransformers.llm_templates API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../autotransformers.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;autotransformers</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#instructions_to_chat">instructions_to_chat</a>
            </li>
            <li>
                    <a class="function" href="#neftune_forward">neftune_forward</a>
            </li>
            <li>
                    <a class="function" href="#activate_neftune">activate_neftune</a>
            </li>
            <li>
                    <a class="class" href="#NEFTuneTrainer">NEFTuneTrainer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NEFTuneTrainer.__init__">NEFTuneTrainer</a>
                        </li>
                        <li>
                                <a class="variable" href="#NEFTuneTrainer.neftune_noise_alpha">neftune_noise_alpha</a>
                        </li>
                        <li>
                                <a class="function" href="#NEFTuneTrainer.train">train</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#QLoraWrapperModelInit">QLoraWrapperModelInit</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#QLoraWrapperModelInit.__init__">QLoraWrapperModelInit</a>
                        </li>
                        <li>
                                <a class="variable" href="#QLoraWrapperModelInit.model_init">model_init</a>
                        </li>
                        <li>
                                <a class="variable" href="#QLoraWrapperModelInit.model_config">model_config</a>
                        </li>
                        <li>
                                <a class="variable" href="#QLoraWrapperModelInit.tokenizer">tokenizer</a>
                        </li>
                        <li>
                                <a class="function" href="#QLoraWrapperModelInit.change_layer_types_for_stability">change_layer_types_for_stability</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#modify_tokenizer">modify_tokenizer</a>
            </li>
            <li>
                    <a class="variable" href="#qlora_config">qlora_config</a>
            </li>
            <li>
                    <a class="class" href="#SavePeftModelCallback">SavePeftModelCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SavePeftModelCallback.save_model">save_model</a>
                        </li>
                        <li>
                                <a class="function" href="#SavePeftModelCallback.on_save">on_save</a>
                        </li>
                        <li>
                                <a class="function" href="#SavePeftModelCallback.on_train_end">on_train_end</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../autotransformers.html">autotransformers</a><wbr>.llm_templates    </h1>

                
                        <input id="mod-llm_templates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-llm_templates-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>    <span class="n">TrainerCallback</span><span class="p">,</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>    <span class="n">PreTrainedModel</span><span class="p">,</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>    <span class="n">PreTrainedTokenizer</span><span class="p">,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>    <span class="n">BitsAndBytesConfig</span><span class="p">,</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>    <span class="n">Trainer</span><span class="p">,</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>    <span class="n">PreTrainedModel</span><span class="p">,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="p">)</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">transformers.trainer_utils</span> <span class="kn">import</span> <span class="n">PREFIX_CHECKPOINT_DIR</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">peft</span> <span class="kn">import</span> <span class="n">prepare_model_for_kbit_training</span><span class="p">,</span> <span class="n">get_peft_model</span><span class="p">,</span> <span class="n">PeftModel</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">peft.tuners.lora</span> <span class="kn">import</span> <span class="n">LoraLayer</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="k">def</span> <span class="nf">instructions_to_chat</span><span class="p">(</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="n">sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="n">input_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>    <span class="n">output_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>    <span class="n">context_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>    <span class="n">nested_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>    <span class="n">system_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    Processes a single sample from any dataset to structure it for chatbot training or instruction-based tasks,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    supporting nested structures and optional fields with a more Pythonic approach.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    Parameters</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    ----------</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">    sample : dict</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">        A dictionary representing a single sample from the dataset.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    input_field : str</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">        The key for the user&#39;s input.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    output_field : str</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        The key for the assistant&#39;s output.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    context_field : str, optional</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        The key for additional context, if any.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    nested_field : str, optional</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        The key for a nested field within the sample, if the data structure is nested.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    system_message : str, optional</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        A system message to initialize the conversation. If None, a default message is used.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    Returns</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    -------</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    dict</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        A modified dictionary with a &#39;messages&#39; key containing ordered messages,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">        each annotated with its role in the conversation.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="n">system_message</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="ow">or</span> <span class="s2">&quot;You are an assistant that solves user&#39;s instructions. Use additional context if provided to complete the instruction.&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>    <span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="n">chat</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">}]</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>    <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">nested</span> <span class="k">else</span> <span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="k">if</span> <span class="n">context</span> <span class="o">:=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">context_field</span><span class="p">,</span> <span class="n">nested_field</span><span class="p">):</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="n">chat</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">})</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">input_content</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">input_field</span><span class="p">,</span> <span class="n">nested_field</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="n">output_content</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">output_field</span><span class="p">,</span> <span class="n">nested_field</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="k">if</span> <span class="n">input_content</span><span class="p">:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="n">chat</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">input_content</span><span class="p">})</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">chat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="p">[</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>            <span class="p">{</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">input_content</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="p">},</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">output_content</span><span class="p">},</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="p">]</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chat</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="k">return</span> <span class="n">sample</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="k">def</span> <span class="nf">neftune_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">    Implement the NEFTune forward pass for the model. Note this works only for torch.nn.Embedding layers.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">    This method is slightly adapted from the original source code that can be found here: https://github.com/neelsjain/NEFTune</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    Parameters</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">    ----------</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    input (`torch.Tensor`):</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        The input tensor to the model.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">    noise_alpha (`float`):</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        The noise alpha value to use for the NEFTune forward pass.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">    Returns</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">    -------</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    embeddings: torch.Tensor</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        Embeddings with random noise added.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="nb">input</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_norm</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_grad_by_freq</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="n">mag_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="o">-</span><span class="n">mag_norm</span><span class="p">,</span> <span class="n">mag_norm</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="k">return</span> <span class="n">embeddings</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="k">def</span> <span class="nf">activate_neftune</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">    Activates Neftune noise injection in the input embeddings of a given model by replacing its original forward method with a custom forward method that includes Neftune noise.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">    This function supports models of type PreTrainedModel and PeftModel. It modifies the model in-place by adding Neftune noise with a specified alpha value to the input embeddings and keeps a reference to the original forward method.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    Parameters</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    ----------</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    model : Union[PreTrainedModel, PeftModel]</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        The model to modify. It should be an instance of either PreTrainedModel or PeftModel.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">    neftune_noise_alpha : float, optional</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        The alpha value for the Neftune noise to be applied. It controls the intensity of the noise injected into the input embeddings. Default value is 5.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">    Returns</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">    -------</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">    model : Union[PreTrainedModel, PeftModel]</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        The modified model with Neftune noise injection activated in its input embeddings.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">    Notes</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">    -----</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    - The activation of Neftune noise involves modifying the forward pass of the model&#39;s input embeddings to include noise injection.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    - This function retains a reference to the original forward method of the embeddings, allowing for potential restoration if needed.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    - The technique used to replace the forward method is based on a discussion from PyTorch&#39;s forums, acknowledging the complexity and hacky nature of this operation.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">    References</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">    ----------</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    - PyTorch Forum Discussion: https://discuss.pytorch.org/t/how-can-i-replace-the-forward-method-of-a-predefined-torchvision-model-with-my-customized-forward-function/54224/11</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PeftModel</span><span class="p">):</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="n">embeddings</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">=</span> <span class="n">neftune_noise_alpha</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="n">old_forward</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">forward</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="c1"># This hack seems to be needed to properly use a custom forward pass</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>    <span class="c1"># all credits to: https://discuss.pytorch.org/t/how-can-i-replace-the-forward-method-of-a-predefined-torchvision-model-with-my-customized-forward-function/54224/11</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="n">bound_method</span> <span class="o">=</span> <span class="n">neftune_forward</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="nb">setattr</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="n">bound_method</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="n">embeddings</span><span class="o">.</span><span class="n">_trl_old_forward</span> <span class="o">=</span> <span class="n">old_forward</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="k">return</span> <span class="n">model</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="k">class</span> <span class="nc">NEFTuneTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">    A custom trainer class for integrating Neftune noise into the training process of models derived from PreTrainedModel or PeftModel.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">    This trainer extends the functionality of the `Trainer` class by allowing the injection of Neftune noise into the input embeddings</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">    during training, and ensures the original forward method is restored after training completes.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">    Parameters</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">    ----------</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">    neftune_noise_alpha : float, optional</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        The alpha value for the Neftune noise to be applied. It controls the intensity of the noise injected into the input embeddings.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        If None, Neftune noise injection is not activated. Default is None.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">    *args : variable length argument list</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        Arguments passed to the `Trainer` class initializer.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">    **kwargs : arbitrary keyword arguments</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        Keyword arguments passed to the `Trainer` class initializer.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">    Methods</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">    -------</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">    train(*args, **kwargs)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">        Extends the `Trainer.train` method by injecting Neftune noise into the model&#39;s input embeddings before training and restoring</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">        the original forward pass method of the embeddings after training.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">    Notes</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">    -----</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">    - It is important to ensure that the `neftune_noise_alpha` is set appropriately to avoid excessively distorting the input embeddings.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">    - The restoration of the original forward method after training is crucial for maintaining the expected behavior of the model outside of training.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">=</span> <span class="n">neftune_noise_alpha</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">Trainer</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        Start the training loop, with an optional integration of Neftune noise into the model&#39;s input embeddings. After training, it ensures that the model&#39;s input embeddings are restored to their original forward pass method, effectively removing the Neftune noise injection.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        This method extends the `train` method of the `Trainer` class, incorporating a step to modify the model for Neftune noise injection before the training begins, if `neftune_noise_alpha` is not None. After the training process, it restores the original forward method of the model&#39;s input embeddings to ensure the model can be used normally post-training.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        Parameters</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        ----------</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        *args : variable length argument list</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">            Arguments to be passed to the `Trainer.train` method.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">        **kwargs : arbitrary keyword arguments</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">            Keyword arguments to be passed to the `Trainer.train` method.</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        Returns</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        -------</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        output : torch.utils.data.DataLoader</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">            The output from the `Trainer.train` method, typically including training statistics and results.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        Notes</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        -----</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        - The method checks if `neftune_noise_alpha` is set and applies Neftune noise injection accordingly.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        - Neftune noise is applied only during training. This method ensures that any modifications are reversed post-training, restoring the original forward pass of the input embeddings.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">        - This design allows the temporary integration of noise for experimental or augmentation purposes without permanently altering the model&#39;s behavior.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="c1"># After training we make sure to retrieve back the original forward pass method</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="c1"># for the embedding layer</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PeftModel</span><span class="p">):</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="s2">&quot;_trl_old_forward&quot;</span><span class="p">):</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="n">embeddings</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">_trl_old_forward</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                <span class="k">del</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">_trl_old_forward</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="k">del</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">neftune_noise_alpha</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="k">class</span> <span class="nc">QLoraWrapperModelInit</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">    A wrapper class for initializing transformer-based models with QLoRa and gradient checkpointing.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">    This class serves as a wrapper for the `model_init` function, which initializes the model.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">    It activates gradient checkpointing when possible and applies QLoRa to the model.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">    Parameters</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">    ----------</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">    model_init : callable</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">        A function that initializes the transformer-based model for training.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">    model_config : Any</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">        The configuration for the model.</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">    tokenizer : Any</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        The tokenizer used for tokenization.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">    Returns</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">    -------</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">    Pre-trained model with QLoRa and gradient checkpointing, if enabled.</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_init</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_init</span> <span class="o">=</span> <span class="n">model_init</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        Initialize the model and apply QLoRa and gradient checkpointing when configured.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        Returns</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        -------</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        Pre-trained model with QLoRa and gradient checkpointing, if enabled.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_init</span><span class="p">()</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">has_gradient_checkpointing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="s2">&quot;MPTForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="s2">&quot;MixFormerSequentialForCausalLM&quot;</span><span class="p">,</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="p">]:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                <span class="n">model</span><span class="o">.</span><span class="n">resize_token_embeddings</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                    <span class="sa">f</span><span class="s2">&quot;Could not resize token embeddings due to </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, but will continue anyway...&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                <span class="n">model</span><span class="o">.</span><span class="n">gradient_checkpointing_enable</span><span class="p">()</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                <span class="n">has_gradient_checkpointing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model checkpointing did not work: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;LlamaForCausalLM&quot;</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pretraining_tp</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">prepare_model_for_kbit_training</span><span class="p">(</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="n">model</span><span class="p">,</span> <span class="n">use_gradient_checkpointing</span><span class="o">=</span><span class="n">has_gradient_checkpointing</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">get_peft_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">peft_config</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">activate_neftune</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">neftune_noise_alpha</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_layer_types_for_stability</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="k">def</span> <span class="nf">change_layer_types_for_stability</span><span class="p">(</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        Change layer types of the model for stability.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        Parameters</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        ----------</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        model : PreTrainedModel</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">            The pre-trained model.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">        Returns</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">        -------</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">        Pre-trained model with modified layer types for stability.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">LoraLayer</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="k">if</span> <span class="s2">&quot;lm_head&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;embed_tokens&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">):</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                    <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="k">def</span> <span class="nf">modify_tokenizer</span><span class="p">(</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>    <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="n">padding_side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>    <span class="n">new_model_seq_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="n">add_special_tokens</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>    <span class="n">add_tokens</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>    <span class="n">chat_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizer</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">    Modify properties of a pre-trained tokenizer.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">    This function allows you to modify various properties of a pre-trained tokenizer,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">    such as the pad_token_id, padding_side, model_max_length, special tokens, and additional tokens.</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">    Parameters</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">    ----------</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">    tokenizer : PreTrainedTokenizer</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        The pre-trained tokenizer to be modified.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">    pad_token_id : int, optional (default=None)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">        The ID of the padding token to set for the tokenizer.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">    padding_side : str, optional (default=None)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        The side (either &#39;left&#39; or &#39;right&#39;) to apply padding.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">    new_model_seq_length : int, optional (default=None)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">        The new maximum sequence length allowed by the tokenizer.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">    add_special_tokens : dict, optional (default=None)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">        A dictionary specifying special tokens to be added to the tokenizer.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">    add_tokens : list, optional (default=None)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        A list of additional tokens to be added to the tokenizer&#39;s vocabulary.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">    chat_template : str, optional (default=None)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        The chat template to use for the tokenizer.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">    Returns</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">    -------</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">    PreTrainedTokenizer</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">        The modified pre-trained tokenizer.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="k">if</span> <span class="n">pad_token_id</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">pad_token_id</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>    <span class="k">if</span> <span class="n">padding_side</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">=</span> <span class="n">padding_side</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>    <span class="k">if</span> <span class="n">new_model_seq_length</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span> <span class="o">=</span> <span class="n">new_model_seq_length</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="k">if</span> <span class="n">add_special_tokens</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">(</span><span class="n">add_special_tokens</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">if</span> <span class="n">add_tokens</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_tokens</span><span class="p">(</span><span class="n">add_tokens</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="k">if</span> <span class="n">chat_template</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="o">=</span> <span class="n">chat_template</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>    <span class="k">return</span> <span class="n">tokenizer</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="n">qlora_config</span> <span class="o">=</span> <span class="n">BitsAndBytesConfig</span><span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>    <span class="n">load_in_4bit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>    <span class="n">bnb_4bit_use_double_quant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>    <span class="n">bnb_4bit_quant_type</span><span class="o">=</span><span class="s2">&quot;nf4&quot;</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>    <span class="n">bnb_4bit_compute_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="k">class</span> <span class="nc">SavePeftModelCallback</span><span class="p">(</span><span class="n">TrainerCallback</span><span class="p">):</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">    Callback for saving only adapter layers from PEFT (Parameter Efficient Fine-Tuning) checkpoints.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">    This callback is designed to be applied to the `transformers.Trainer` to save adapter layers</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">    from PEFT checkpoints instead of saving full model weights.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">    Methods</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">    -------</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">    save_model(args, state, kwargs):</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        Save the adapter model from the PEFT checkpoint.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">    on_save(args, state, control, **kwargs):</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        Triggered when saving the model during training. Calls `save_model` and returns control.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">    on_train_end(args, state, control, **kwargs):</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        Triggered at the end of training. Creates a &#39;completed&#39; file and calls `save_model`.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">        Save the adapter model from the PEFT checkpoint.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">        Parameters</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        ----------</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        state : TrainerState</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">            Current trainer state.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">        kwargs : dict</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">            Additional keyword arguments, including the model.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">        Returns</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        -------</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        None</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving PEFT checkpoint...&quot;</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">best_model_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="n">checkpoint_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">best_model_checkpoint</span><span class="p">,</span> <span class="s2">&quot;adapter_model&quot;</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">checkpoint_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PREFIX_CHECKPOINT_DIR</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>        <span class="n">peft_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_folder</span><span class="p">,</span> <span class="s2">&quot;adapter_model&quot;</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">peft_model_path</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="n">pytorch_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_folder</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pytorch_model_path</span><span class="p">):</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pytorch_model_path</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="k">def</span> <span class="nf">on_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="sd">        Triggered when saving the model during training. Calls `save_model` and returns control.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">        Parameters</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">        ----------</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        state : TrainerState</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">            Current trainer state.</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">        control : str</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">            Control string for trainer callback.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        kwargs : dict</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">            Additional keyword arguments.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        Returns</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">        -------</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">        str</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">            Control string.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="k">return</span> <span class="n">control</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">        Triggered at the end of training. Creates a &#39;completed&#39; file and calls `save_model`.</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">        Parameters</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">        ----------</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">        state : TrainerState</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a><span class="sd">            Current trainer state.</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">        control : str</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a><span class="sd">            Control string for trainer callback.</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">        kwargs : dict</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">            Additional keyword arguments.</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">        Returns</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        -------</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        None</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">):</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="n">touch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">))</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="instructions_to_chat">
                            <input id="instructions_to_chat-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">instructions_to_chat</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sample</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">input_field</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">output_field</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">context_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nested_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">system_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="instructions_to_chat-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#instructions_to_chat"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="instructions_to_chat-19"><a href="#instructions_to_chat-19"><span class="linenos">19</span></a><span class="k">def</span> <span class="nf">instructions_to_chat</span><span class="p">(</span>
</span><span id="instructions_to_chat-20"><a href="#instructions_to_chat-20"><span class="linenos">20</span></a>    <span class="n">sample</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="instructions_to_chat-21"><a href="#instructions_to_chat-21"><span class="linenos">21</span></a>    <span class="n">input_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="instructions_to_chat-22"><a href="#instructions_to_chat-22"><span class="linenos">22</span></a>    <span class="n">output_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="instructions_to_chat-23"><a href="#instructions_to_chat-23"><span class="linenos">23</span></a>    <span class="n">context_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="instructions_to_chat-24"><a href="#instructions_to_chat-24"><span class="linenos">24</span></a>    <span class="n">nested_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="instructions_to_chat-25"><a href="#instructions_to_chat-25"><span class="linenos">25</span></a>    <span class="n">system_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="instructions_to_chat-26"><a href="#instructions_to_chat-26"><span class="linenos">26</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="instructions_to_chat-27"><a href="#instructions_to_chat-27"><span class="linenos">27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="instructions_to_chat-28"><a href="#instructions_to_chat-28"><span class="linenos">28</span></a><span class="sd">    Processes a single sample from any dataset to structure it for chatbot training or instruction-based tasks,</span>
</span><span id="instructions_to_chat-29"><a href="#instructions_to_chat-29"><span class="linenos">29</span></a><span class="sd">    supporting nested structures and optional fields with a more Pythonic approach.</span>
</span><span id="instructions_to_chat-30"><a href="#instructions_to_chat-30"><span class="linenos">30</span></a>
</span><span id="instructions_to_chat-31"><a href="#instructions_to_chat-31"><span class="linenos">31</span></a><span class="sd">    Parameters</span>
</span><span id="instructions_to_chat-32"><a href="#instructions_to_chat-32"><span class="linenos">32</span></a><span class="sd">    ----------</span>
</span><span id="instructions_to_chat-33"><a href="#instructions_to_chat-33"><span class="linenos">33</span></a><span class="sd">    sample : dict</span>
</span><span id="instructions_to_chat-34"><a href="#instructions_to_chat-34"><span class="linenos">34</span></a><span class="sd">        A dictionary representing a single sample from the dataset.</span>
</span><span id="instructions_to_chat-35"><a href="#instructions_to_chat-35"><span class="linenos">35</span></a><span class="sd">    input_field : str</span>
</span><span id="instructions_to_chat-36"><a href="#instructions_to_chat-36"><span class="linenos">36</span></a><span class="sd">        The key for the user&#39;s input.</span>
</span><span id="instructions_to_chat-37"><a href="#instructions_to_chat-37"><span class="linenos">37</span></a><span class="sd">    output_field : str</span>
</span><span id="instructions_to_chat-38"><a href="#instructions_to_chat-38"><span class="linenos">38</span></a><span class="sd">        The key for the assistant&#39;s output.</span>
</span><span id="instructions_to_chat-39"><a href="#instructions_to_chat-39"><span class="linenos">39</span></a><span class="sd">    context_field : str, optional</span>
</span><span id="instructions_to_chat-40"><a href="#instructions_to_chat-40"><span class="linenos">40</span></a><span class="sd">        The key for additional context, if any.</span>
</span><span id="instructions_to_chat-41"><a href="#instructions_to_chat-41"><span class="linenos">41</span></a><span class="sd">    nested_field : str, optional</span>
</span><span id="instructions_to_chat-42"><a href="#instructions_to_chat-42"><span class="linenos">42</span></a><span class="sd">        The key for a nested field within the sample, if the data structure is nested.</span>
</span><span id="instructions_to_chat-43"><a href="#instructions_to_chat-43"><span class="linenos">43</span></a><span class="sd">    system_message : str, optional</span>
</span><span id="instructions_to_chat-44"><a href="#instructions_to_chat-44"><span class="linenos">44</span></a><span class="sd">        A system message to initialize the conversation. If None, a default message is used.</span>
</span><span id="instructions_to_chat-45"><a href="#instructions_to_chat-45"><span class="linenos">45</span></a>
</span><span id="instructions_to_chat-46"><a href="#instructions_to_chat-46"><span class="linenos">46</span></a><span class="sd">    Returns</span>
</span><span id="instructions_to_chat-47"><a href="#instructions_to_chat-47"><span class="linenos">47</span></a><span class="sd">    -------</span>
</span><span id="instructions_to_chat-48"><a href="#instructions_to_chat-48"><span class="linenos">48</span></a><span class="sd">    dict</span>
</span><span id="instructions_to_chat-49"><a href="#instructions_to_chat-49"><span class="linenos">49</span></a><span class="sd">        A modified dictionary with a &#39;messages&#39; key containing ordered messages,</span>
</span><span id="instructions_to_chat-50"><a href="#instructions_to_chat-50"><span class="linenos">50</span></a><span class="sd">        each annotated with its role in the conversation.</span>
</span><span id="instructions_to_chat-51"><a href="#instructions_to_chat-51"><span class="linenos">51</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="instructions_to_chat-52"><a href="#instructions_to_chat-52"><span class="linenos">52</span></a>    <span class="n">system_msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="instructions_to_chat-53"><a href="#instructions_to_chat-53"><span class="linenos">53</span></a>        <span class="n">system_message</span>
</span><span id="instructions_to_chat-54"><a href="#instructions_to_chat-54"><span class="linenos">54</span></a>        <span class="ow">or</span> <span class="s2">&quot;You are an assistant that solves user&#39;s instructions. Use additional context if provided to complete the instruction.&quot;</span>
</span><span id="instructions_to_chat-55"><a href="#instructions_to_chat-55"><span class="linenos">55</span></a>    <span class="p">)</span>
</span><span id="instructions_to_chat-56"><a href="#instructions_to_chat-56"><span class="linenos">56</span></a>    <span class="n">chat</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">}]</span>
</span><span id="instructions_to_chat-57"><a href="#instructions_to_chat-57"><span class="linenos">57</span></a>
</span><span id="instructions_to_chat-58"><a href="#instructions_to_chat-58"><span class="linenos">58</span></a>    <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="instructions_to_chat-59"><a href="#instructions_to_chat-59"><span class="linenos">59</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">nested</span> <span class="k">else</span> <span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="instructions_to_chat-60"><a href="#instructions_to_chat-60"><span class="linenos">60</span></a>
</span><span id="instructions_to_chat-61"><a href="#instructions_to_chat-61"><span class="linenos">61</span></a>    <span class="k">if</span> <span class="n">context</span> <span class="o">:=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">context_field</span><span class="p">,</span> <span class="n">nested_field</span><span class="p">):</span>
</span><span id="instructions_to_chat-62"><a href="#instructions_to_chat-62"><span class="linenos">62</span></a>        <span class="n">chat</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">})</span>
</span><span id="instructions_to_chat-63"><a href="#instructions_to_chat-63"><span class="linenos">63</span></a>
</span><span id="instructions_to_chat-64"><a href="#instructions_to_chat-64"><span class="linenos">64</span></a>    <span class="n">input_content</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">input_field</span><span class="p">,</span> <span class="n">nested_field</span><span class="p">)</span>
</span><span id="instructions_to_chat-65"><a href="#instructions_to_chat-65"><span class="linenos">65</span></a>    <span class="n">output_content</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">output_field</span><span class="p">,</span> <span class="n">nested_field</span><span class="p">)</span>
</span><span id="instructions_to_chat-66"><a href="#instructions_to_chat-66"><span class="linenos">66</span></a>
</span><span id="instructions_to_chat-67"><a href="#instructions_to_chat-67"><span class="linenos">67</span></a>    <span class="k">if</span> <span class="n">input_content</span><span class="p">:</span>
</span><span id="instructions_to_chat-68"><a href="#instructions_to_chat-68"><span class="linenos">68</span></a>        <span class="n">chat</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">input_content</span><span class="p">})</span>
</span><span id="instructions_to_chat-69"><a href="#instructions_to_chat-69"><span class="linenos">69</span></a>
</span><span id="instructions_to_chat-70"><a href="#instructions_to_chat-70"><span class="linenos">70</span></a>    <span class="n">chat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span id="instructions_to_chat-71"><a href="#instructions_to_chat-71"><span class="linenos">71</span></a>        <span class="p">[</span>
</span><span id="instructions_to_chat-72"><a href="#instructions_to_chat-72"><span class="linenos">72</span></a>            <span class="p">{</span>
</span><span id="instructions_to_chat-73"><a href="#instructions_to_chat-73"><span class="linenos">73</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="instructions_to_chat-74"><a href="#instructions_to_chat-74"><span class="linenos">74</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">input_content</span><span class="p">,</span>
</span><span id="instructions_to_chat-75"><a href="#instructions_to_chat-75"><span class="linenos">75</span></a>            <span class="p">},</span>
</span><span id="instructions_to_chat-76"><a href="#instructions_to_chat-76"><span class="linenos">76</span></a>            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">output_content</span><span class="p">},</span>
</span><span id="instructions_to_chat-77"><a href="#instructions_to_chat-77"><span class="linenos">77</span></a>        <span class="p">]</span>
</span><span id="instructions_to_chat-78"><a href="#instructions_to_chat-78"><span class="linenos">78</span></a>    <span class="p">)</span>
</span><span id="instructions_to_chat-79"><a href="#instructions_to_chat-79"><span class="linenos">79</span></a>
</span><span id="instructions_to_chat-80"><a href="#instructions_to_chat-80"><span class="linenos">80</span></a>    <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chat</span>
</span><span id="instructions_to_chat-81"><a href="#instructions_to_chat-81"><span class="linenos">81</span></a>    <span class="k">return</span> <span class="n">sample</span>
</span></pre></div>


            <div class="docstring"><p>Processes a single sample from any dataset to structure it for chatbot training or instruction-based tasks,
supporting nested structures and optional fields with a more Pythonic approach.</p>

<h2 id="parameters">Parameters</h2>

<p>sample : dict
    A dictionary representing a single sample from the dataset.
input_field : str
    The key for the user's input.
output_field : str
    The key for the assistant's output.
context_field : str, optional
    The key for additional context, if any.
nested_field : str, optional
    The key for a nested field within the sample, if the data structure is nested.
system_message : str, optional
    A system message to initialize the conversation. If None, a default message is used.</p>

<h2 id="returns">Returns</h2>

<p>dict
    A modified dictionary with a 'messages' key containing ordered messages,
    each annotated with its role in the conversation.</p>
</div>


                </section>
                <section id="neftune_forward">
                            <input id="neftune_forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">neftune_forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="neftune_forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#neftune_forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="neftune_forward-84"><a href="#neftune_forward-84"><span class="linenos"> 84</span></a><span class="k">def</span> <span class="nf">neftune_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="neftune_forward-85"><a href="#neftune_forward-85"><span class="linenos"> 85</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="neftune_forward-86"><a href="#neftune_forward-86"><span class="linenos"> 86</span></a><span class="sd">    Implement the NEFTune forward pass for the model. Note this works only for torch.nn.Embedding layers.</span>
</span><span id="neftune_forward-87"><a href="#neftune_forward-87"><span class="linenos"> 87</span></a>
</span><span id="neftune_forward-88"><a href="#neftune_forward-88"><span class="linenos"> 88</span></a><span class="sd">    This method is slightly adapted from the original source code that can be found here: https://github.com/neelsjain/NEFTune</span>
</span><span id="neftune_forward-89"><a href="#neftune_forward-89"><span class="linenos"> 89</span></a>
</span><span id="neftune_forward-90"><a href="#neftune_forward-90"><span class="linenos"> 90</span></a><span class="sd">    Parameters</span>
</span><span id="neftune_forward-91"><a href="#neftune_forward-91"><span class="linenos"> 91</span></a><span class="sd">    ----------</span>
</span><span id="neftune_forward-92"><a href="#neftune_forward-92"><span class="linenos"> 92</span></a><span class="sd">    input (`torch.Tensor`):</span>
</span><span id="neftune_forward-93"><a href="#neftune_forward-93"><span class="linenos"> 93</span></a><span class="sd">        The input tensor to the model.</span>
</span><span id="neftune_forward-94"><a href="#neftune_forward-94"><span class="linenos"> 94</span></a><span class="sd">    noise_alpha (`float`):</span>
</span><span id="neftune_forward-95"><a href="#neftune_forward-95"><span class="linenos"> 95</span></a><span class="sd">        The noise alpha value to use for the NEFTune forward pass.</span>
</span><span id="neftune_forward-96"><a href="#neftune_forward-96"><span class="linenos"> 96</span></a>
</span><span id="neftune_forward-97"><a href="#neftune_forward-97"><span class="linenos"> 97</span></a><span class="sd">    Returns</span>
</span><span id="neftune_forward-98"><a href="#neftune_forward-98"><span class="linenos"> 98</span></a><span class="sd">    -------</span>
</span><span id="neftune_forward-99"><a href="#neftune_forward-99"><span class="linenos"> 99</span></a><span class="sd">    embeddings: torch.Tensor</span>
</span><span id="neftune_forward-100"><a href="#neftune_forward-100"><span class="linenos">100</span></a><span class="sd">        Embeddings with random noise added.</span>
</span><span id="neftune_forward-101"><a href="#neftune_forward-101"><span class="linenos">101</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="neftune_forward-102"><a href="#neftune_forward-102"><span class="linenos">102</span></a>    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
</span><span id="neftune_forward-103"><a href="#neftune_forward-103"><span class="linenos">103</span></a>        <span class="nb">input</span><span class="p">,</span>
</span><span id="neftune_forward-104"><a href="#neftune_forward-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
</span><span id="neftune_forward-105"><a href="#neftune_forward-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">padding_idx</span><span class="p">,</span>
</span><span id="neftune_forward-106"><a href="#neftune_forward-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_norm</span><span class="p">,</span>
</span><span id="neftune_forward-107"><a href="#neftune_forward-107"><span class="linenos">107</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">,</span>
</span><span id="neftune_forward-108"><a href="#neftune_forward-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_grad_by_freq</span><span class="p">,</span>
</span><span id="neftune_forward-109"><a href="#neftune_forward-109"><span class="linenos">109</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sparse</span><span class="p">,</span>
</span><span id="neftune_forward-110"><a href="#neftune_forward-110"><span class="linenos">110</span></a>    <span class="p">)</span>
</span><span id="neftune_forward-111"><a href="#neftune_forward-111"><span class="linenos">111</span></a>
</span><span id="neftune_forward-112"><a href="#neftune_forward-112"><span class="linenos">112</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
</span><span id="neftune_forward-113"><a href="#neftune_forward-113"><span class="linenos">113</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><span id="neftune_forward-114"><a href="#neftune_forward-114"><span class="linenos">114</span></a>        <span class="n">mag_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
</span><span id="neftune_forward-115"><a href="#neftune_forward-115"><span class="linenos">115</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span>
</span><span id="neftune_forward-116"><a href="#neftune_forward-116"><span class="linenos">116</span></a>            <span class="o">-</span><span class="n">mag_norm</span><span class="p">,</span> <span class="n">mag_norm</span>
</span><span id="neftune_forward-117"><a href="#neftune_forward-117"><span class="linenos">117</span></a>        <span class="p">)</span>
</span><span id="neftune_forward-118"><a href="#neftune_forward-118"><span class="linenos">118</span></a>
</span><span id="neftune_forward-119"><a href="#neftune_forward-119"><span class="linenos">119</span></a>    <span class="k">return</span> <span class="n">embeddings</span>
</span></pre></div>


            <div class="docstring"><p>Implement the NEFTune forward pass for the model. Note this works only for torch.nn.Embedding layers.</p>

<p>This method is slightly adapted from the original source code that can be found here: <a href="https://github.com/neelsjain/NEFTune">https://github.com/neelsjain/NEFTune</a></p>

<h2 id="parameters">Parameters</h2>

<p>input (<code>torch.Tensor</code>):
    The input tensor to the model.
noise_alpha (<code>float</code>):
    The noise alpha value to use for the NEFTune forward pass.</p>

<h2 id="returns">Returns</h2>

<p>embeddings: torch.Tensor
    Embeddings with random noise added.</p>
</div>


                </section>
                <section id="activate_neftune">
                            <input id="activate_neftune-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">activate_neftune</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">model</span>, </span><span class="param"><span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="mi">5</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="activate_neftune-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#activate_neftune"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="activate_neftune-122"><a href="#activate_neftune-122"><span class="linenos">122</span></a><span class="k">def</span> <span class="nf">activate_neftune</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="activate_neftune-123"><a href="#activate_neftune-123"><span class="linenos">123</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="activate_neftune-124"><a href="#activate_neftune-124"><span class="linenos">124</span></a><span class="sd">    Activates Neftune noise injection in the input embeddings of a given model by replacing its original forward method with a custom forward method that includes Neftune noise.</span>
</span><span id="activate_neftune-125"><a href="#activate_neftune-125"><span class="linenos">125</span></a>
</span><span id="activate_neftune-126"><a href="#activate_neftune-126"><span class="linenos">126</span></a><span class="sd">    This function supports models of type PreTrainedModel and PeftModel. It modifies the model in-place by adding Neftune noise with a specified alpha value to the input embeddings and keeps a reference to the original forward method.</span>
</span><span id="activate_neftune-127"><a href="#activate_neftune-127"><span class="linenos">127</span></a>
</span><span id="activate_neftune-128"><a href="#activate_neftune-128"><span class="linenos">128</span></a><span class="sd">    Parameters</span>
</span><span id="activate_neftune-129"><a href="#activate_neftune-129"><span class="linenos">129</span></a><span class="sd">    ----------</span>
</span><span id="activate_neftune-130"><a href="#activate_neftune-130"><span class="linenos">130</span></a><span class="sd">    model : Union[PreTrainedModel, PeftModel]</span>
</span><span id="activate_neftune-131"><a href="#activate_neftune-131"><span class="linenos">131</span></a><span class="sd">        The model to modify. It should be an instance of either PreTrainedModel or PeftModel.</span>
</span><span id="activate_neftune-132"><a href="#activate_neftune-132"><span class="linenos">132</span></a><span class="sd">    neftune_noise_alpha : float, optional</span>
</span><span id="activate_neftune-133"><a href="#activate_neftune-133"><span class="linenos">133</span></a><span class="sd">        The alpha value for the Neftune noise to be applied. It controls the intensity of the noise injected into the input embeddings. Default value is 5.</span>
</span><span id="activate_neftune-134"><a href="#activate_neftune-134"><span class="linenos">134</span></a>
</span><span id="activate_neftune-135"><a href="#activate_neftune-135"><span class="linenos">135</span></a><span class="sd">    Returns</span>
</span><span id="activate_neftune-136"><a href="#activate_neftune-136"><span class="linenos">136</span></a><span class="sd">    -------</span>
</span><span id="activate_neftune-137"><a href="#activate_neftune-137"><span class="linenos">137</span></a><span class="sd">    model : Union[PreTrainedModel, PeftModel]</span>
</span><span id="activate_neftune-138"><a href="#activate_neftune-138"><span class="linenos">138</span></a><span class="sd">        The modified model with Neftune noise injection activated in its input embeddings.</span>
</span><span id="activate_neftune-139"><a href="#activate_neftune-139"><span class="linenos">139</span></a>
</span><span id="activate_neftune-140"><a href="#activate_neftune-140"><span class="linenos">140</span></a><span class="sd">    Notes</span>
</span><span id="activate_neftune-141"><a href="#activate_neftune-141"><span class="linenos">141</span></a><span class="sd">    -----</span>
</span><span id="activate_neftune-142"><a href="#activate_neftune-142"><span class="linenos">142</span></a><span class="sd">    - The activation of Neftune noise involves modifying the forward pass of the model&#39;s input embeddings to include noise injection.</span>
</span><span id="activate_neftune-143"><a href="#activate_neftune-143"><span class="linenos">143</span></a><span class="sd">    - This function retains a reference to the original forward method of the embeddings, allowing for potential restoration if needed.</span>
</span><span id="activate_neftune-144"><a href="#activate_neftune-144"><span class="linenos">144</span></a><span class="sd">    - The technique used to replace the forward method is based on a discussion from PyTorch&#39;s forums, acknowledging the complexity and hacky nature of this operation.</span>
</span><span id="activate_neftune-145"><a href="#activate_neftune-145"><span class="linenos">145</span></a>
</span><span id="activate_neftune-146"><a href="#activate_neftune-146"><span class="linenos">146</span></a><span class="sd">    References</span>
</span><span id="activate_neftune-147"><a href="#activate_neftune-147"><span class="linenos">147</span></a><span class="sd">    ----------</span>
</span><span id="activate_neftune-148"><a href="#activate_neftune-148"><span class="linenos">148</span></a><span class="sd">    - PyTorch Forum Discussion: https://discuss.pytorch.org/t/how-can-i-replace-the-forward-method-of-a-predefined-torchvision-model-with-my-customized-forward-function/54224/11</span>
</span><span id="activate_neftune-149"><a href="#activate_neftune-149"><span class="linenos">149</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="activate_neftune-150"><a href="#activate_neftune-150"><span class="linenos">150</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
</span><span id="activate_neftune-151"><a href="#activate_neftune-151"><span class="linenos">151</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="activate_neftune-152"><a href="#activate_neftune-152"><span class="linenos">152</span></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PeftModel</span><span class="p">):</span>
</span><span id="activate_neftune-153"><a href="#activate_neftune-153"><span class="linenos">153</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="activate_neftune-154"><a href="#activate_neftune-154"><span class="linenos">154</span></a>
</span><span id="activate_neftune-155"><a href="#activate_neftune-155"><span class="linenos">155</span></a>    <span class="n">embeddings</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">=</span> <span class="n">neftune_noise_alpha</span>
</span><span id="activate_neftune-156"><a href="#activate_neftune-156"><span class="linenos">156</span></a>    <span class="n">old_forward</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">forward</span>
</span><span id="activate_neftune-157"><a href="#activate_neftune-157"><span class="linenos">157</span></a>
</span><span id="activate_neftune-158"><a href="#activate_neftune-158"><span class="linenos">158</span></a>    <span class="c1"># This hack seems to be needed to properly use a custom forward pass</span>
</span><span id="activate_neftune-159"><a href="#activate_neftune-159"><span class="linenos">159</span></a>    <span class="c1"># all credits to: https://discuss.pytorch.org/t/how-can-i-replace-the-forward-method-of-a-predefined-torchvision-model-with-my-customized-forward-function/54224/11</span>
</span><span id="activate_neftune-160"><a href="#activate_neftune-160"><span class="linenos">160</span></a>    <span class="n">bound_method</span> <span class="o">=</span> <span class="n">neftune_forward</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
</span><span id="activate_neftune-161"><a href="#activate_neftune-161"><span class="linenos">161</span></a>    <span class="nb">setattr</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="n">bound_method</span><span class="p">)</span>
</span><span id="activate_neftune-162"><a href="#activate_neftune-162"><span class="linenos">162</span></a>
</span><span id="activate_neftune-163"><a href="#activate_neftune-163"><span class="linenos">163</span></a>    <span class="n">embeddings</span><span class="o">.</span><span class="n">_trl_old_forward</span> <span class="o">=</span> <span class="n">old_forward</span>
</span><span id="activate_neftune-164"><a href="#activate_neftune-164"><span class="linenos">164</span></a>    <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Activates Neftune noise injection in the input embeddings of a given model by replacing its original forward method with a custom forward method that includes Neftune noise.</p>

<p>This function supports models of type PreTrainedModel and PeftModel. It modifies the model in-place by adding Neftune noise with a specified alpha value to the input embeddings and keeps a reference to the original forward method.</p>

<h2 id="parameters">Parameters</h2>

<p>model : Union[PreTrainedModel, PeftModel]
    The model to modify. It should be an instance of either PreTrainedModel or PeftModel.
neftune_noise_alpha : float, optional
    The alpha value for the Neftune noise to be applied. It controls the intensity of the noise injected into the input embeddings. Default value is 5.</p>

<h2 id="returns">Returns</h2>

<p>model : Union[PreTrainedModel, PeftModel]
    The modified model with Neftune noise injection activated in its input embeddings.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The activation of Neftune noise involves modifying the forward pass of the model's input embeddings to include noise injection.</li>
<li>This function retains a reference to the original forward method of the embeddings, allowing for potential restoration if needed.</li>
<li>The technique used to replace the forward method is based on a discussion from PyTorch's forums, acknowledging the complexity and hacky nature of this operation.</li>
</ul>

<h2 id="references">References</h2>

<ul>
<li>PyTorch Forum Discussion: <a href="https://discuss.pytorch.org/t/how-can-i-replace-the-forward-method-of-a-predefined-torchvision-model-with-my-customized-forward-function/54224/11">https://discuss.pytorch.org/t/how-can-i-replace-the-forward-method-of-a-predefined-torchvision-model-with-my-customized-forward-function/54224/11</a></li>
</ul>
</div>


                </section>
                <section id="NEFTuneTrainer">
                            <input id="NEFTuneTrainer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NEFTuneTrainer</span><wbr>(<span class="base">transformers.trainer.Trainer</span>):

                <label class="view-source-button" for="NEFTuneTrainer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NEFTuneTrainer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NEFTuneTrainer-167"><a href="#NEFTuneTrainer-167"><span class="linenos">167</span></a><span class="k">class</span> <span class="nc">NEFTuneTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>
</span><span id="NEFTuneTrainer-168"><a href="#NEFTuneTrainer-168"><span class="linenos">168</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NEFTuneTrainer-169"><a href="#NEFTuneTrainer-169"><span class="linenos">169</span></a><span class="sd">    A custom trainer class for integrating Neftune noise into the training process of models derived from PreTrainedModel or PeftModel.</span>
</span><span id="NEFTuneTrainer-170"><a href="#NEFTuneTrainer-170"><span class="linenos">170</span></a>
</span><span id="NEFTuneTrainer-171"><a href="#NEFTuneTrainer-171"><span class="linenos">171</span></a><span class="sd">    This trainer extends the functionality of the `Trainer` class by allowing the injection of Neftune noise into the input embeddings</span>
</span><span id="NEFTuneTrainer-172"><a href="#NEFTuneTrainer-172"><span class="linenos">172</span></a><span class="sd">    during training, and ensures the original forward method is restored after training completes.</span>
</span><span id="NEFTuneTrainer-173"><a href="#NEFTuneTrainer-173"><span class="linenos">173</span></a>
</span><span id="NEFTuneTrainer-174"><a href="#NEFTuneTrainer-174"><span class="linenos">174</span></a><span class="sd">    Parameters</span>
</span><span id="NEFTuneTrainer-175"><a href="#NEFTuneTrainer-175"><span class="linenos">175</span></a><span class="sd">    ----------</span>
</span><span id="NEFTuneTrainer-176"><a href="#NEFTuneTrainer-176"><span class="linenos">176</span></a><span class="sd">    neftune_noise_alpha : float, optional</span>
</span><span id="NEFTuneTrainer-177"><a href="#NEFTuneTrainer-177"><span class="linenos">177</span></a><span class="sd">        The alpha value for the Neftune noise to be applied. It controls the intensity of the noise injected into the input embeddings.</span>
</span><span id="NEFTuneTrainer-178"><a href="#NEFTuneTrainer-178"><span class="linenos">178</span></a><span class="sd">        If None, Neftune noise injection is not activated. Default is None.</span>
</span><span id="NEFTuneTrainer-179"><a href="#NEFTuneTrainer-179"><span class="linenos">179</span></a><span class="sd">    *args : variable length argument list</span>
</span><span id="NEFTuneTrainer-180"><a href="#NEFTuneTrainer-180"><span class="linenos">180</span></a><span class="sd">        Arguments passed to the `Trainer` class initializer.</span>
</span><span id="NEFTuneTrainer-181"><a href="#NEFTuneTrainer-181"><span class="linenos">181</span></a><span class="sd">    **kwargs : arbitrary keyword arguments</span>
</span><span id="NEFTuneTrainer-182"><a href="#NEFTuneTrainer-182"><span class="linenos">182</span></a><span class="sd">        Keyword arguments passed to the `Trainer` class initializer.</span>
</span><span id="NEFTuneTrainer-183"><a href="#NEFTuneTrainer-183"><span class="linenos">183</span></a>
</span><span id="NEFTuneTrainer-184"><a href="#NEFTuneTrainer-184"><span class="linenos">184</span></a><span class="sd">    Methods</span>
</span><span id="NEFTuneTrainer-185"><a href="#NEFTuneTrainer-185"><span class="linenos">185</span></a><span class="sd">    -------</span>
</span><span id="NEFTuneTrainer-186"><a href="#NEFTuneTrainer-186"><span class="linenos">186</span></a><span class="sd">    train(*args, **kwargs)</span>
</span><span id="NEFTuneTrainer-187"><a href="#NEFTuneTrainer-187"><span class="linenos">187</span></a><span class="sd">        Extends the `Trainer.train` method by injecting Neftune noise into the model&#39;s input embeddings before training and restoring</span>
</span><span id="NEFTuneTrainer-188"><a href="#NEFTuneTrainer-188"><span class="linenos">188</span></a><span class="sd">        the original forward pass method of the embeddings after training.</span>
</span><span id="NEFTuneTrainer-189"><a href="#NEFTuneTrainer-189"><span class="linenos">189</span></a>
</span><span id="NEFTuneTrainer-190"><a href="#NEFTuneTrainer-190"><span class="linenos">190</span></a><span class="sd">    Notes</span>
</span><span id="NEFTuneTrainer-191"><a href="#NEFTuneTrainer-191"><span class="linenos">191</span></a><span class="sd">    -----</span>
</span><span id="NEFTuneTrainer-192"><a href="#NEFTuneTrainer-192"><span class="linenos">192</span></a><span class="sd">    - It is important to ensure that the `neftune_noise_alpha` is set appropriately to avoid excessively distorting the input embeddings.</span>
</span><span id="NEFTuneTrainer-193"><a href="#NEFTuneTrainer-193"><span class="linenos">193</span></a><span class="sd">    - The restoration of the original forward method after training is crucial for maintaining the expected behavior of the model outside of training.</span>
</span><span id="NEFTuneTrainer-194"><a href="#NEFTuneTrainer-194"><span class="linenos">194</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NEFTuneTrainer-195"><a href="#NEFTuneTrainer-195"><span class="linenos">195</span></a>
</span><span id="NEFTuneTrainer-196"><a href="#NEFTuneTrainer-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="NEFTuneTrainer-197"><a href="#NEFTuneTrainer-197"><span class="linenos">197</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="NEFTuneTrainer-198"><a href="#NEFTuneTrainer-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">=</span> <span class="n">neftune_noise_alpha</span>
</span><span id="NEFTuneTrainer-199"><a href="#NEFTuneTrainer-199"><span class="linenos">199</span></a>
</span><span id="NEFTuneTrainer-200"><a href="#NEFTuneTrainer-200"><span class="linenos">200</span></a>    <span class="nd">@wraps</span><span class="p">(</span><span class="n">Trainer</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
</span><span id="NEFTuneTrainer-201"><a href="#NEFTuneTrainer-201"><span class="linenos">201</span></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="NEFTuneTrainer-202"><a href="#NEFTuneTrainer-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NEFTuneTrainer-203"><a href="#NEFTuneTrainer-203"><span class="linenos">203</span></a><span class="sd">        Start the training loop, with an optional integration of Neftune noise into the model&#39;s input embeddings. After training, it ensures that the model&#39;s input embeddings are restored to their original forward pass method, effectively removing the Neftune noise injection.</span>
</span><span id="NEFTuneTrainer-204"><a href="#NEFTuneTrainer-204"><span class="linenos">204</span></a>
</span><span id="NEFTuneTrainer-205"><a href="#NEFTuneTrainer-205"><span class="linenos">205</span></a><span class="sd">        This method extends the `train` method of the `Trainer` class, incorporating a step to modify the model for Neftune noise injection before the training begins, if `neftune_noise_alpha` is not None. After the training process, it restores the original forward method of the model&#39;s input embeddings to ensure the model can be used normally post-training.</span>
</span><span id="NEFTuneTrainer-206"><a href="#NEFTuneTrainer-206"><span class="linenos">206</span></a>
</span><span id="NEFTuneTrainer-207"><a href="#NEFTuneTrainer-207"><span class="linenos">207</span></a><span class="sd">        Parameters</span>
</span><span id="NEFTuneTrainer-208"><a href="#NEFTuneTrainer-208"><span class="linenos">208</span></a><span class="sd">        ----------</span>
</span><span id="NEFTuneTrainer-209"><a href="#NEFTuneTrainer-209"><span class="linenos">209</span></a><span class="sd">        *args : variable length argument list</span>
</span><span id="NEFTuneTrainer-210"><a href="#NEFTuneTrainer-210"><span class="linenos">210</span></a><span class="sd">            Arguments to be passed to the `Trainer.train` method.</span>
</span><span id="NEFTuneTrainer-211"><a href="#NEFTuneTrainer-211"><span class="linenos">211</span></a><span class="sd">        **kwargs : arbitrary keyword arguments</span>
</span><span id="NEFTuneTrainer-212"><a href="#NEFTuneTrainer-212"><span class="linenos">212</span></a><span class="sd">            Keyword arguments to be passed to the `Trainer.train` method.</span>
</span><span id="NEFTuneTrainer-213"><a href="#NEFTuneTrainer-213"><span class="linenos">213</span></a>
</span><span id="NEFTuneTrainer-214"><a href="#NEFTuneTrainer-214"><span class="linenos">214</span></a><span class="sd">        Returns</span>
</span><span id="NEFTuneTrainer-215"><a href="#NEFTuneTrainer-215"><span class="linenos">215</span></a><span class="sd">        -------</span>
</span><span id="NEFTuneTrainer-216"><a href="#NEFTuneTrainer-216"><span class="linenos">216</span></a><span class="sd">        output : torch.utils.data.DataLoader</span>
</span><span id="NEFTuneTrainer-217"><a href="#NEFTuneTrainer-217"><span class="linenos">217</span></a><span class="sd">            The output from the `Trainer.train` method, typically including training statistics and results.</span>
</span><span id="NEFTuneTrainer-218"><a href="#NEFTuneTrainer-218"><span class="linenos">218</span></a>
</span><span id="NEFTuneTrainer-219"><a href="#NEFTuneTrainer-219"><span class="linenos">219</span></a><span class="sd">        Notes</span>
</span><span id="NEFTuneTrainer-220"><a href="#NEFTuneTrainer-220"><span class="linenos">220</span></a><span class="sd">        -----</span>
</span><span id="NEFTuneTrainer-221"><a href="#NEFTuneTrainer-221"><span class="linenos">221</span></a><span class="sd">        - The method checks if `neftune_noise_alpha` is set and applies Neftune noise injection accordingly.</span>
</span><span id="NEFTuneTrainer-222"><a href="#NEFTuneTrainer-222"><span class="linenos">222</span></a><span class="sd">        - Neftune noise is applied only during training. This method ensures that any modifications are reversed post-training, restoring the original forward pass of the input embeddings.</span>
</span><span id="NEFTuneTrainer-223"><a href="#NEFTuneTrainer-223"><span class="linenos">223</span></a><span class="sd">        - This design allows the temporary integration of noise for experimental or augmentation purposes without permanently altering the model&#39;s behavior.</span>
</span><span id="NEFTuneTrainer-224"><a href="#NEFTuneTrainer-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NEFTuneTrainer-225"><a href="#NEFTuneTrainer-225"><span class="linenos">225</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="NEFTuneTrainer-226"><a href="#NEFTuneTrainer-226"><span class="linenos">226</span></a>        <span class="c1"># After training we make sure to retrieve back the original forward pass method</span>
</span><span id="NEFTuneTrainer-227"><a href="#NEFTuneTrainer-227"><span class="linenos">227</span></a>        <span class="c1"># for the embedding layer</span>
</span><span id="NEFTuneTrainer-228"><a href="#NEFTuneTrainer-228"><span class="linenos">228</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NEFTuneTrainer-229"><a href="#NEFTuneTrainer-229"><span class="linenos">229</span></a>
</span><span id="NEFTuneTrainer-230"><a href="#NEFTuneTrainer-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
</span><span id="NEFTuneTrainer-231"><a href="#NEFTuneTrainer-231"><span class="linenos">231</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="NEFTuneTrainer-232"><a href="#NEFTuneTrainer-232"><span class="linenos">232</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PeftModel</span><span class="p">):</span>
</span><span id="NEFTuneTrainer-233"><a href="#NEFTuneTrainer-233"><span class="linenos">233</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span>
</span><span id="NEFTuneTrainer-234"><a href="#NEFTuneTrainer-234"><span class="linenos">234</span></a>
</span><span id="NEFTuneTrainer-235"><a href="#NEFTuneTrainer-235"><span class="linenos">235</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="s2">&quot;_trl_old_forward&quot;</span><span class="p">):</span>
</span><span id="NEFTuneTrainer-236"><a href="#NEFTuneTrainer-236"><span class="linenos">236</span></a>                <span class="n">embeddings</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">_trl_old_forward</span>
</span><span id="NEFTuneTrainer-237"><a href="#NEFTuneTrainer-237"><span class="linenos">237</span></a>                <span class="k">del</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">_trl_old_forward</span>
</span><span id="NEFTuneTrainer-238"><a href="#NEFTuneTrainer-238"><span class="linenos">238</span></a>                <span class="k">del</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">neftune_noise_alpha</span>
</span><span id="NEFTuneTrainer-239"><a href="#NEFTuneTrainer-239"><span class="linenos">239</span></a>        <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


            <div class="docstring"><p>A custom trainer class for integrating Neftune noise into the training process of models derived from PreTrainedModel or PeftModel.</p>

<p>This trainer extends the functionality of the <code>Trainer</code> class by allowing the injection of Neftune noise into the input embeddings
during training, and ensures the original forward method is restored after training completes.</p>

<h2 id="parameters">Parameters</h2>

<p>neftune_noise_alpha : float, optional
    The alpha value for the Neftune noise to be applied. It controls the intensity of the noise injected into the input embeddings.
    If None, Neftune noise injection is not activated. Default is None.
<em>args : variable length argument list
    Arguments passed to the <code>Trainer</code> class initializer.
*</em>kwargs : arbitrary keyword arguments
    Keyword arguments passed to the <code>Trainer</code> class initializer.</p>

<h2 id="methods">Methods</h2>

<p>train(<em>args, *</em>kwargs)
    Extends the <code>Trainer.train</code> method by injecting Neftune noise into the model's input embeddings before training and restoring
    the original forward pass method of the embeddings after training.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>It is important to ensure that the <code><a href="#NEFTuneTrainer.neftune_noise_alpha">neftune_noise_alpha</a></code> is set appropriately to avoid excessively distorting the input embeddings.</li>
<li>The restoration of the original forward method after training is crucial for maintaining the expected behavior of the model outside of training.</li>
</ul>
</div>


                            <div id="NEFTuneTrainer.__init__" class="classattr">
                                        <input id="NEFTuneTrainer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NEFTuneTrainer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="NEFTuneTrainer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NEFTuneTrainer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NEFTuneTrainer.__init__-196"><a href="#NEFTuneTrainer.__init__-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neftune_noise_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="NEFTuneTrainer.__init__-197"><a href="#NEFTuneTrainer.__init__-197"><span class="linenos">197</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.__init__-198"><a href="#NEFTuneTrainer.__init__-198"><span class="linenos">198</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="o">=</span> <span class="n">neftune_noise_alpha</span>
</span></pre></div>


    

                            </div>
                            <div id="NEFTuneTrainer.neftune_noise_alpha" class="classattr">
                                <div class="attr variable">
            <span class="name">neftune_noise_alpha</span>

        
    </div>
    <a class="headerlink" href="#NEFTuneTrainer.neftune_noise_alpha"></a>
    
    

                            </div>
                            <div id="NEFTuneTrainer.train" class="classattr">
                                        <input id="NEFTuneTrainer.train-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">train</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">resume_from_checkpoint</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">trial</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">optuna</span><span class="o">.</span><span class="n">trial</span><span class="o">.</span><span class="n">_trial</span><span class="o">.</span><span class="n">Trial</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">ignore_keys_for_eval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NEFTuneTrainer.train-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NEFTuneTrainer.train"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NEFTuneTrainer.train-1524"><a href="#NEFTuneTrainer.train-1524"><span class="linenos">1524</span></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
</span><span id="NEFTuneTrainer.train-1525"><a href="#NEFTuneTrainer.train-1525"><span class="linenos">1525</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1526"><a href="#NEFTuneTrainer.train-1526"><span class="linenos">1526</span></a>        <span class="n">resume_from_checkpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1527"><a href="#NEFTuneTrainer.train-1527"><span class="linenos">1527</span></a>        <span class="n">trial</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;optuna.Trial&quot;</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1528"><a href="#NEFTuneTrainer.train-1528"><span class="linenos">1528</span></a>        <span class="n">ignore_keys_for_eval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1529"><a href="#NEFTuneTrainer.train-1529"><span class="linenos">1529</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1530"><a href="#NEFTuneTrainer.train-1530"><span class="linenos">1530</span></a>    <span class="p">):</span>
</span><span id="NEFTuneTrainer.train-1531"><a href="#NEFTuneTrainer.train-1531"><span class="linenos">1531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NEFTuneTrainer.train-1532"><a href="#NEFTuneTrainer.train-1532"><span class="linenos">1532</span></a><span class="sd">        Main training entry point.</span>
</span><span id="NEFTuneTrainer.train-1533"><a href="#NEFTuneTrainer.train-1533"><span class="linenos">1533</span></a>
</span><span id="NEFTuneTrainer.train-1534"><a href="#NEFTuneTrainer.train-1534"><span class="linenos">1534</span></a><span class="sd">        Args:</span>
</span><span id="NEFTuneTrainer.train-1535"><a href="#NEFTuneTrainer.train-1535"><span class="linenos">1535</span></a><span class="sd">            resume_from_checkpoint (`str` or `bool`, *optional*):</span>
</span><span id="NEFTuneTrainer.train-1536"><a href="#NEFTuneTrainer.train-1536"><span class="linenos">1536</span></a><span class="sd">                If a `str`, local path to a saved checkpoint as saved by a previous instance of [`Trainer`]. If a</span>
</span><span id="NEFTuneTrainer.train-1537"><a href="#NEFTuneTrainer.train-1537"><span class="linenos">1537</span></a><span class="sd">                `bool` and equals `True`, load the last checkpoint in *args.output_dir* as saved by a previous instance</span>
</span><span id="NEFTuneTrainer.train-1538"><a href="#NEFTuneTrainer.train-1538"><span class="linenos">1538</span></a><span class="sd">                of [`Trainer`]. If present, training will resume from the model/optimizer/scheduler states loaded here.</span>
</span><span id="NEFTuneTrainer.train-1539"><a href="#NEFTuneTrainer.train-1539"><span class="linenos">1539</span></a><span class="sd">            trial (`optuna.Trial` or `Dict[str, Any]`, *optional*):</span>
</span><span id="NEFTuneTrainer.train-1540"><a href="#NEFTuneTrainer.train-1540"><span class="linenos">1540</span></a><span class="sd">                The trial run or the hyperparameter dictionary for hyperparameter search.</span>
</span><span id="NEFTuneTrainer.train-1541"><a href="#NEFTuneTrainer.train-1541"><span class="linenos">1541</span></a><span class="sd">            ignore_keys_for_eval (`List[str]`, *optional*)</span>
</span><span id="NEFTuneTrainer.train-1542"><a href="#NEFTuneTrainer.train-1542"><span class="linenos">1542</span></a><span class="sd">                A list of keys in the output of your model (if it is a dictionary) that should be ignored when</span>
</span><span id="NEFTuneTrainer.train-1543"><a href="#NEFTuneTrainer.train-1543"><span class="linenos">1543</span></a><span class="sd">                gathering predictions for evaluation during the training.</span>
</span><span id="NEFTuneTrainer.train-1544"><a href="#NEFTuneTrainer.train-1544"><span class="linenos">1544</span></a><span class="sd">            kwargs (`Dict[str, Any]`, *optional*):</span>
</span><span id="NEFTuneTrainer.train-1545"><a href="#NEFTuneTrainer.train-1545"><span class="linenos">1545</span></a><span class="sd">                Additional keyword arguments used to hide deprecated arguments</span>
</span><span id="NEFTuneTrainer.train-1546"><a href="#NEFTuneTrainer.train-1546"><span class="linenos">1546</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NEFTuneTrainer.train-1547"><a href="#NEFTuneTrainer.train-1547"><span class="linenos">1547</span></a>        <span class="k">if</span> <span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1548"><a href="#NEFTuneTrainer.train-1548"><span class="linenos">1548</span></a>            <span class="n">resume_from_checkpoint</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NEFTuneTrainer.train-1549"><a href="#NEFTuneTrainer.train-1549"><span class="linenos">1549</span></a>
</span><span id="NEFTuneTrainer.train-1550"><a href="#NEFTuneTrainer.train-1550"><span class="linenos">1550</span></a>        <span class="c1"># memory metrics - must set up as early as possible</span>
</span><span id="NEFTuneTrainer.train-1551"><a href="#NEFTuneTrainer.train-1551"><span class="linenos">1551</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_memory_tracker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="NEFTuneTrainer.train-1552"><a href="#NEFTuneTrainer.train-1552"><span class="linenos">1552</span></a>
</span><span id="NEFTuneTrainer.train-1553"><a href="#NEFTuneTrainer.train-1553"><span class="linenos">1553</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
</span><span id="NEFTuneTrainer.train-1554"><a href="#NEFTuneTrainer.train-1554"><span class="linenos">1554</span></a>
</span><span id="NEFTuneTrainer.train-1555"><a href="#NEFTuneTrainer.train-1555"><span class="linenos">1555</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_in_train</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="NEFTuneTrainer.train-1556"><a href="#NEFTuneTrainer.train-1556"><span class="linenos">1556</span></a>
</span><span id="NEFTuneTrainer.train-1557"><a href="#NEFTuneTrainer.train-1557"><span class="linenos">1557</span></a>        <span class="c1"># Attach NEFTune hooks if necessary</span>
</span><span id="NEFTuneTrainer.train-1558"><a href="#NEFTuneTrainer.train-1558"><span class="linenos">1558</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1559"><a href="#NEFTuneTrainer.train-1559"><span class="linenos">1559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activate_neftune</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1560"><a href="#NEFTuneTrainer.train-1560"><span class="linenos">1560</span></a>
</span><span id="NEFTuneTrainer.train-1561"><a href="#NEFTuneTrainer.train-1561"><span class="linenos">1561</span></a>        <span class="c1"># do_train is not a reliable argument, as it might not be set and .train() still called, so</span>
</span><span id="NEFTuneTrainer.train-1562"><a href="#NEFTuneTrainer.train-1562"><span class="linenos">1562</span></a>        <span class="c1"># the following is a workaround:</span>
</span><span id="NEFTuneTrainer.train-1563"><a href="#NEFTuneTrainer.train-1563"><span class="linenos">1563</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fp16_full_eval</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">bf16_full_eval</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1564"><a href="#NEFTuneTrainer.train-1564"><span class="linenos">1564</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_move_model_to_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1565"><a href="#NEFTuneTrainer.train-1565"><span class="linenos">1565</span></a>
</span><span id="NEFTuneTrainer.train-1566"><a href="#NEFTuneTrainer.train-1566"><span class="linenos">1566</span></a>        <span class="k">if</span> <span class="s2">&quot;model_path&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1567"><a href="#NEFTuneTrainer.train-1567"><span class="linenos">1567</span></a>            <span class="n">resume_from_checkpoint</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_path&quot;</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1568"><a href="#NEFTuneTrainer.train-1568"><span class="linenos">1568</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="NEFTuneTrainer.train-1569"><a href="#NEFTuneTrainer.train-1569"><span class="linenos">1569</span></a>                <span class="s2">&quot;`model_path` is deprecated and will be removed in a future version. Use `resume_from_checkpoint` &quot;</span>
</span><span id="NEFTuneTrainer.train-1570"><a href="#NEFTuneTrainer.train-1570"><span class="linenos">1570</span></a>                <span class="s2">&quot;instead.&quot;</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1571"><a href="#NEFTuneTrainer.train-1571"><span class="linenos">1571</span></a>                <span class="ne">FutureWarning</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1572"><a href="#NEFTuneTrainer.train-1572"><span class="linenos">1572</span></a>            <span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1573"><a href="#NEFTuneTrainer.train-1573"><span class="linenos">1573</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1574"><a href="#NEFTuneTrainer.train-1574"><span class="linenos">1574</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train() received got unexpected keyword arguments: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1575"><a href="#NEFTuneTrainer.train-1575"><span class="linenos">1575</span></a>        <span class="c1"># This might change the seed so needs to run first.</span>
</span><span id="NEFTuneTrainer.train-1576"><a href="#NEFTuneTrainer.train-1576"><span class="linenos">1576</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_hp_search_setup</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1577"><a href="#NEFTuneTrainer.train-1577"><span class="linenos">1577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_train_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span>
</span><span id="NEFTuneTrainer.train-1578"><a href="#NEFTuneTrainer.train-1578"><span class="linenos">1578</span></a>
</span><span id="NEFTuneTrainer.train-1579"><a href="#NEFTuneTrainer.train-1579"><span class="linenos">1579</span></a>        <span class="c1"># Model re-init</span>
</span><span id="NEFTuneTrainer.train-1580"><a href="#NEFTuneTrainer.train-1580"><span class="linenos">1580</span></a>        <span class="n">model_reloaded</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="NEFTuneTrainer.train-1581"><a href="#NEFTuneTrainer.train-1581"><span class="linenos">1581</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1582"><a href="#NEFTuneTrainer.train-1582"><span class="linenos">1582</span></a>            <span class="c1"># Seed must be set before instantiating the model when using model_init.</span>
</span><span id="NEFTuneTrainer.train-1583"><a href="#NEFTuneTrainer.train-1583"><span class="linenos">1583</span></a>            <span class="n">enable_full_determinism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">full_determinism</span> <span class="k">else</span> <span class="n">set_seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1584"><a href="#NEFTuneTrainer.train-1584"><span class="linenos">1584</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_model_init</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1585"><a href="#NEFTuneTrainer.train-1585"><span class="linenos">1585</span></a>            <span class="n">model_reloaded</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="NEFTuneTrainer.train-1586"><a href="#NEFTuneTrainer.train-1586"><span class="linenos">1586</span></a>            <span class="c1"># Reinitializes optimizer and scheduler</span>
</span><span id="NEFTuneTrainer.train-1587"><a href="#NEFTuneTrainer.train-1587"><span class="linenos">1587</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="NEFTuneTrainer.train-1588"><a href="#NEFTuneTrainer.train-1588"><span class="linenos">1588</span></a>
</span><span id="NEFTuneTrainer.train-1589"><a href="#NEFTuneTrainer.train-1589"><span class="linenos">1589</span></a>        <span class="c1"># Load potential model checkpoint</span>
</span><span id="NEFTuneTrainer.train-1590"><a href="#NEFTuneTrainer.train-1590"><span class="linenos">1590</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resume_from_checkpoint</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1591"><a href="#NEFTuneTrainer.train-1591"><span class="linenos">1591</span></a>            <span class="n">resume_from_checkpoint</span> <span class="o">=</span> <span class="n">get_last_checkpoint</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1592"><a href="#NEFTuneTrainer.train-1592"><span class="linenos">1592</span></a>            <span class="k">if</span> <span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1593"><a href="#NEFTuneTrainer.train-1593"><span class="linenos">1593</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid checkpoint found in output directory (</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1594"><a href="#NEFTuneTrainer.train-1594"><span class="linenos">1594</span></a>
</span><span id="NEFTuneTrainer.train-1595"><a href="#NEFTuneTrainer.train-1595"><span class="linenos">1595</span></a>        <span class="k">if</span> <span class="n">resume_from_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1596"><a href="#NEFTuneTrainer.train-1596"><span class="linenos">1596</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sagemaker_mp_enabled</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_deepspeed_enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fsdp_enabled</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1597"><a href="#NEFTuneTrainer.train-1597"><span class="linenos">1597</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_checkpoint</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1598"><a href="#NEFTuneTrainer.train-1598"><span class="linenos">1598</span></a>            <span class="c1"># In case of repeating the find_executable_batch_size, set `self._train_batch_size` properly</span>
</span><span id="NEFTuneTrainer.train-1599"><a href="#NEFTuneTrainer.train-1599"><span class="linenos">1599</span></a>            <span class="n">state</span> <span class="o">=</span> <span class="n">TrainerState</span><span class="o">.</span><span class="n">load_from_json</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resume_from_checkpoint</span><span class="p">,</span> <span class="n">TRAINER_STATE_NAME</span><span class="p">))</span>
</span><span id="NEFTuneTrainer.train-1600"><a href="#NEFTuneTrainer.train-1600"><span class="linenos">1600</span></a>            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">train_batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1601"><a href="#NEFTuneTrainer.train-1601"><span class="linenos">1601</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_train_batch_size</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">train_batch_size</span>
</span><span id="NEFTuneTrainer.train-1602"><a href="#NEFTuneTrainer.train-1602"><span class="linenos">1602</span></a>
</span><span id="NEFTuneTrainer.train-1603"><a href="#NEFTuneTrainer.train-1603"><span class="linenos">1603</span></a>        <span class="c1"># If model was re-initialized, put it on the right device and update self.model_wrapped</span>
</span><span id="NEFTuneTrainer.train-1604"><a href="#NEFTuneTrainer.train-1604"><span class="linenos">1604</span></a>        <span class="k">if</span> <span class="n">model_reloaded</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1605"><a href="#NEFTuneTrainer.train-1605"><span class="linenos">1605</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_model_on_device</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1606"><a href="#NEFTuneTrainer.train-1606"><span class="linenos">1606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_move_model_to_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1607"><a href="#NEFTuneTrainer.train-1607"><span class="linenos">1607</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</span><span id="NEFTuneTrainer.train-1608"><a href="#NEFTuneTrainer.train-1608"><span class="linenos">1608</span></a>
</span><span id="NEFTuneTrainer.train-1609"><a href="#NEFTuneTrainer.train-1609"><span class="linenos">1609</span></a>        <span class="n">inner_training_loop</span> <span class="o">=</span> <span class="n">find_executable_batch_size</span><span class="p">(</span>
</span><span id="NEFTuneTrainer.train-1610"><a href="#NEFTuneTrainer.train-1610"><span class="linenos">1610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_inner_training_loop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_batch_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">auto_find_batch_size</span>
</span><span id="NEFTuneTrainer.train-1611"><a href="#NEFTuneTrainer.train-1611"><span class="linenos">1611</span></a>        <span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1612"><a href="#NEFTuneTrainer.train-1612"><span class="linenos">1612</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1613"><a href="#NEFTuneTrainer.train-1613"><span class="linenos">1613</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1614"><a href="#NEFTuneTrainer.train-1614"><span class="linenos">1614</span></a>                <span class="c1"># Disable progress bars when uploading models during checkpoints to avoid polluting stdout</span>
</span><span id="NEFTuneTrainer.train-1615"><a href="#NEFTuneTrainer.train-1615"><span class="linenos">1615</span></a>                <span class="n">hf_hub_utils</span><span class="o">.</span><span class="n">disable_progress_bars</span><span class="p">()</span>
</span><span id="NEFTuneTrainer.train-1616"><a href="#NEFTuneTrainer.train-1616"><span class="linenos">1616</span></a>                <span class="k">return</span> <span class="n">inner_training_loop</span><span class="p">(</span>
</span><span id="NEFTuneTrainer.train-1617"><a href="#NEFTuneTrainer.train-1617"><span class="linenos">1617</span></a>                    <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1618"><a href="#NEFTuneTrainer.train-1618"><span class="linenos">1618</span></a>                    <span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="n">resume_from_checkpoint</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1619"><a href="#NEFTuneTrainer.train-1619"><span class="linenos">1619</span></a>                    <span class="n">trial</span><span class="o">=</span><span class="n">trial</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1620"><a href="#NEFTuneTrainer.train-1620"><span class="linenos">1620</span></a>                    <span class="n">ignore_keys_for_eval</span><span class="o">=</span><span class="n">ignore_keys_for_eval</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1621"><a href="#NEFTuneTrainer.train-1621"><span class="linenos">1621</span></a>                <span class="p">)</span>
</span><span id="NEFTuneTrainer.train-1622"><a href="#NEFTuneTrainer.train-1622"><span class="linenos">1622</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1623"><a href="#NEFTuneTrainer.train-1623"><span class="linenos">1623</span></a>                <span class="n">hf_hub_utils</span><span class="o">.</span><span class="n">enable_progress_bars</span><span class="p">()</span>
</span><span id="NEFTuneTrainer.train-1624"><a href="#NEFTuneTrainer.train-1624"><span class="linenos">1624</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NEFTuneTrainer.train-1625"><a href="#NEFTuneTrainer.train-1625"><span class="linenos">1625</span></a>            <span class="k">return</span> <span class="n">inner_training_loop</span><span class="p">(</span>
</span><span id="NEFTuneTrainer.train-1626"><a href="#NEFTuneTrainer.train-1626"><span class="linenos">1626</span></a>                <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1627"><a href="#NEFTuneTrainer.train-1627"><span class="linenos">1627</span></a>                <span class="n">resume_from_checkpoint</span><span class="o">=</span><span class="n">resume_from_checkpoint</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1628"><a href="#NEFTuneTrainer.train-1628"><span class="linenos">1628</span></a>                <span class="n">trial</span><span class="o">=</span><span class="n">trial</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1629"><a href="#NEFTuneTrainer.train-1629"><span class="linenos">1629</span></a>                <span class="n">ignore_keys_for_eval</span><span class="o">=</span><span class="n">ignore_keys_for_eval</span><span class="p">,</span>
</span><span id="NEFTuneTrainer.train-1630"><a href="#NEFTuneTrainer.train-1630"><span class="linenos">1630</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Main training entry point.</p>

<p>Args:
    resume_from_checkpoint (<code>str</code> or <code>bool</code>, <em>optional</em>):
        If a <code>str</code>, local path to a saved checkpoint as saved by a previous instance of [<code>Trainer</code>]. If a
        <code>bool</code> and equals <code>True</code>, load the last checkpoint in <em>args.output_dir</em> as saved by a previous instance
        of [<code>Trainer</code>]. If present, training will resume from the model/optimizer/scheduler states loaded here.
    trial (<code>optuna.Trial</code> or <code>Dict[str, Any]</code>, <em>optional</em>):
        The trial run or the hyperparameter dictionary for hyperparameter search.
    ignore_keys_for_eval (<code>List[str]</code>, <em>optional</em>)
        A list of keys in the output of your model (if it is a dictionary) that should be ignored when
        gathering predictions for evaluation during the training.
    kwargs (<code>Dict[str, Any]</code>, <em>optional</em>):
        Additional keyword arguments used to hide deprecated arguments</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>transformers.trainer.Trainer</dt>
                                <dd id="NEFTuneTrainer.args" class="variable">args</dd>
                <dd id="NEFTuneTrainer.hp_name" class="variable">hp_name</dd>
                <dd id="NEFTuneTrainer.deepspeed" class="variable">deepspeed</dd>
                <dd id="NEFTuneTrainer.is_in_train" class="variable">is_in_train</dd>
                <dd id="NEFTuneTrainer.is_fsdp_xla_enabled" class="variable">is_fsdp_xla_enabled</dd>
                <dd id="NEFTuneTrainer.place_model_on_device" class="variable">place_model_on_device</dd>
                <dd id="NEFTuneTrainer.data_collator" class="variable">data_collator</dd>
                <dd id="NEFTuneTrainer.train_dataset" class="variable">train_dataset</dd>
                <dd id="NEFTuneTrainer.eval_dataset" class="variable">eval_dataset</dd>
                <dd id="NEFTuneTrainer.tokenizer" class="variable">tokenizer</dd>
                <dd id="NEFTuneTrainer.model_wrapped" class="variable">model_wrapped</dd>
                <dd id="NEFTuneTrainer.model" class="variable">model</dd>
                <dd id="NEFTuneTrainer.compute_metrics" class="variable">compute_metrics</dd>
                <dd id="NEFTuneTrainer.preprocess_logits_for_metrics" class="variable">preprocess_logits_for_metrics</dd>
                <dd id="NEFTuneTrainer.callback_handler" class="variable">callback_handler</dd>
                <dd id="NEFTuneTrainer.hub_model_id" class="variable">hub_model_id</dd>
                <dd id="NEFTuneTrainer.use_apex" class="variable">use_apex</dd>
                <dd id="NEFTuneTrainer.use_cpu_amp" class="variable">use_cpu_amp</dd>
                <dd id="NEFTuneTrainer.state" class="variable">state</dd>
                <dd id="NEFTuneTrainer.control" class="variable">control</dd>
                <dd id="NEFTuneTrainer.current_flos" class="variable">current_flos</dd>
                <dd id="NEFTuneTrainer.hp_search_backend" class="variable">hp_search_backend</dd>
                <dd id="NEFTuneTrainer.label_names" class="variable">label_names</dd>
                <dd id="NEFTuneTrainer.can_return_loss" class="variable">can_return_loss</dd>
                <dd id="NEFTuneTrainer.is_fsdp_xla_v2_enabled" class="variable">is_fsdp_xla_v2_enabled</dd>
                <dd id="NEFTuneTrainer.add_callback" class="function">add_callback</dd>
                <dd id="NEFTuneTrainer.pop_callback" class="function">pop_callback</dd>
                <dd id="NEFTuneTrainer.remove_callback" class="function">remove_callback</dd>
                <dd id="NEFTuneTrainer.get_train_dataloader" class="function">get_train_dataloader</dd>
                <dd id="NEFTuneTrainer.get_eval_dataloader" class="function">get_eval_dataloader</dd>
                <dd id="NEFTuneTrainer.get_test_dataloader" class="function">get_test_dataloader</dd>
                <dd id="NEFTuneTrainer.create_optimizer_and_scheduler" class="function">create_optimizer_and_scheduler</dd>
                <dd id="NEFTuneTrainer.get_decay_parameter_names" class="function">get_decay_parameter_names</dd>
                <dd id="NEFTuneTrainer.create_optimizer" class="function">create_optimizer</dd>
                <dd id="NEFTuneTrainer.get_optimizer_cls_and_kwargs" class="function">get_optimizer_cls_and_kwargs</dd>
                <dd id="NEFTuneTrainer.create_scheduler" class="function">create_scheduler</dd>
                <dd id="NEFTuneTrainer.num_examples" class="function">num_examples</dd>
                <dd id="NEFTuneTrainer.num_tokens" class="function">num_tokens</dd>
                <dd id="NEFTuneTrainer.call_model_init" class="function">call_model_init</dd>
                <dd id="NEFTuneTrainer.torch_jit_model_eval" class="function">torch_jit_model_eval</dd>
                <dd id="NEFTuneTrainer.ipex_optimize_model" class="function">ipex_optimize_model</dd>
                <dd id="NEFTuneTrainer.hyperparameter_search" class="function">hyperparameter_search</dd>
                <dd id="NEFTuneTrainer.log" class="function">log</dd>
                <dd id="NEFTuneTrainer.compute_loss_context_manager" class="function">compute_loss_context_manager</dd>
                <dd id="NEFTuneTrainer.autocast_smart_context_manager" class="function">autocast_smart_context_manager</dd>
                <dd id="NEFTuneTrainer.training_step" class="function">training_step</dd>
                <dd id="NEFTuneTrainer.compute_loss" class="function">compute_loss</dd>
                <dd id="NEFTuneTrainer.is_local_process_zero" class="function">is_local_process_zero</dd>
                <dd id="NEFTuneTrainer.is_world_process_zero" class="function">is_world_process_zero</dd>
                <dd id="NEFTuneTrainer.save_model" class="function">save_model</dd>
                <dd id="NEFTuneTrainer.store_flos" class="function">store_flos</dd>
                <dd id="NEFTuneTrainer.evaluate" class="function">evaluate</dd>
                <dd id="NEFTuneTrainer.predict" class="function">predict</dd>
                <dd id="NEFTuneTrainer.evaluation_loop" class="function">evaluation_loop</dd>
                <dd id="NEFTuneTrainer.prediction_step" class="function">prediction_step</dd>
                <dd id="NEFTuneTrainer.floating_point_ops" class="function">floating_point_ops</dd>
                <dd id="NEFTuneTrainer.init_hf_repo" class="function">init_hf_repo</dd>
                <dd id="NEFTuneTrainer.create_model_card" class="function">create_model_card</dd>
                <dd id="NEFTuneTrainer.push_to_hub" class="function">push_to_hub</dd>
                <dd id="NEFTuneTrainer.prediction_loop" class="function">prediction_loop</dd>
                <dd id="NEFTuneTrainer.create_accelerator_and_postprocess" class="function">create_accelerator_and_postprocess</dd>
                <dd id="NEFTuneTrainer.propagate_args_to_deepspeed" class="function">propagate_args_to_deepspeed</dd>
                <dd id="NEFTuneTrainer.log_metrics" class="function">log_metrics</dd>
                <dd id="NEFTuneTrainer.metrics_format" class="function">metrics_format</dd>
                <dd id="NEFTuneTrainer.save_metrics" class="function">save_metrics</dd>
                <dd id="NEFTuneTrainer.save_state" class="function">save_state</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="QLoraWrapperModelInit">
                            <input id="QLoraWrapperModelInit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">QLoraWrapperModelInit</span>:

                <label class="view-source-button" for="QLoraWrapperModelInit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QLoraWrapperModelInit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QLoraWrapperModelInit-242"><a href="#QLoraWrapperModelInit-242"><span class="linenos">242</span></a><span class="k">class</span> <span class="nc">QLoraWrapperModelInit</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-243"><a href="#QLoraWrapperModelInit-243"><span class="linenos">243</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit-244"><a href="#QLoraWrapperModelInit-244"><span class="linenos">244</span></a><span class="sd">    A wrapper class for initializing transformer-based models with QLoRa and gradient checkpointing.</span>
</span><span id="QLoraWrapperModelInit-245"><a href="#QLoraWrapperModelInit-245"><span class="linenos">245</span></a>
</span><span id="QLoraWrapperModelInit-246"><a href="#QLoraWrapperModelInit-246"><span class="linenos">246</span></a><span class="sd">    This class serves as a wrapper for the `model_init` function, which initializes the model.</span>
</span><span id="QLoraWrapperModelInit-247"><a href="#QLoraWrapperModelInit-247"><span class="linenos">247</span></a><span class="sd">    It activates gradient checkpointing when possible and applies QLoRa to the model.</span>
</span><span id="QLoraWrapperModelInit-248"><a href="#QLoraWrapperModelInit-248"><span class="linenos">248</span></a>
</span><span id="QLoraWrapperModelInit-249"><a href="#QLoraWrapperModelInit-249"><span class="linenos">249</span></a><span class="sd">    Parameters</span>
</span><span id="QLoraWrapperModelInit-250"><a href="#QLoraWrapperModelInit-250"><span class="linenos">250</span></a><span class="sd">    ----------</span>
</span><span id="QLoraWrapperModelInit-251"><a href="#QLoraWrapperModelInit-251"><span class="linenos">251</span></a><span class="sd">    model_init : callable</span>
</span><span id="QLoraWrapperModelInit-252"><a href="#QLoraWrapperModelInit-252"><span class="linenos">252</span></a><span class="sd">        A function that initializes the transformer-based model for training.</span>
</span><span id="QLoraWrapperModelInit-253"><a href="#QLoraWrapperModelInit-253"><span class="linenos">253</span></a><span class="sd">    model_config : Any</span>
</span><span id="QLoraWrapperModelInit-254"><a href="#QLoraWrapperModelInit-254"><span class="linenos">254</span></a><span class="sd">        The configuration for the model.</span>
</span><span id="QLoraWrapperModelInit-255"><a href="#QLoraWrapperModelInit-255"><span class="linenos">255</span></a><span class="sd">    tokenizer : Any</span>
</span><span id="QLoraWrapperModelInit-256"><a href="#QLoraWrapperModelInit-256"><span class="linenos">256</span></a><span class="sd">        The tokenizer used for tokenization.</span>
</span><span id="QLoraWrapperModelInit-257"><a href="#QLoraWrapperModelInit-257"><span class="linenos">257</span></a>
</span><span id="QLoraWrapperModelInit-258"><a href="#QLoraWrapperModelInit-258"><span class="linenos">258</span></a><span class="sd">    Returns</span>
</span><span id="QLoraWrapperModelInit-259"><a href="#QLoraWrapperModelInit-259"><span class="linenos">259</span></a><span class="sd">    -------</span>
</span><span id="QLoraWrapperModelInit-260"><a href="#QLoraWrapperModelInit-260"><span class="linenos">260</span></a><span class="sd">    Pre-trained model with QLoRa and gradient checkpointing, if enabled.</span>
</span><span id="QLoraWrapperModelInit-261"><a href="#QLoraWrapperModelInit-261"><span class="linenos">261</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit-262"><a href="#QLoraWrapperModelInit-262"><span class="linenos">262</span></a>
</span><span id="QLoraWrapperModelInit-263"><a href="#QLoraWrapperModelInit-263"><span class="linenos">263</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_init</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-264"><a href="#QLoraWrapperModelInit-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_init</span> <span class="o">=</span> <span class="n">model_init</span>
</span><span id="QLoraWrapperModelInit-265"><a href="#QLoraWrapperModelInit-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
</span><span id="QLoraWrapperModelInit-266"><a href="#QLoraWrapperModelInit-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span><span id="QLoraWrapperModelInit-267"><a href="#QLoraWrapperModelInit-267"><span class="linenos">267</span></a>
</span><span id="QLoraWrapperModelInit-268"><a href="#QLoraWrapperModelInit-268"><span class="linenos">268</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-269"><a href="#QLoraWrapperModelInit-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit-270"><a href="#QLoraWrapperModelInit-270"><span class="linenos">270</span></a><span class="sd">        Initialize the model and apply QLoRa and gradient checkpointing when configured.</span>
</span><span id="QLoraWrapperModelInit-271"><a href="#QLoraWrapperModelInit-271"><span class="linenos">271</span></a>
</span><span id="QLoraWrapperModelInit-272"><a href="#QLoraWrapperModelInit-272"><span class="linenos">272</span></a><span class="sd">        Returns</span>
</span><span id="QLoraWrapperModelInit-273"><a href="#QLoraWrapperModelInit-273"><span class="linenos">273</span></a><span class="sd">        -------</span>
</span><span id="QLoraWrapperModelInit-274"><a href="#QLoraWrapperModelInit-274"><span class="linenos">274</span></a><span class="sd">        Pre-trained model with QLoRa and gradient checkpointing, if enabled.</span>
</span><span id="QLoraWrapperModelInit-275"><a href="#QLoraWrapperModelInit-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit-276"><a href="#QLoraWrapperModelInit-276"><span class="linenos">276</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_init</span><span class="p">()</span>
</span><span id="QLoraWrapperModelInit-277"><a href="#QLoraWrapperModelInit-277"><span class="linenos">277</span></a>        <span class="n">has_gradient_checkpointing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="QLoraWrapperModelInit-278"><a href="#QLoraWrapperModelInit-278"><span class="linenos">278</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="QLoraWrapperModelInit-279"><a href="#QLoraWrapperModelInit-279"><span class="linenos">279</span></a>            <span class="s2">&quot;MPTForCausalLM&quot;</span><span class="p">,</span>
</span><span id="QLoraWrapperModelInit-280"><a href="#QLoraWrapperModelInit-280"><span class="linenos">280</span></a>            <span class="s2">&quot;MixFormerSequentialForCausalLM&quot;</span><span class="p">,</span>
</span><span id="QLoraWrapperModelInit-281"><a href="#QLoraWrapperModelInit-281"><span class="linenos">281</span></a>        <span class="p">]:</span>
</span><span id="QLoraWrapperModelInit-282"><a href="#QLoraWrapperModelInit-282"><span class="linenos">282</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-283"><a href="#QLoraWrapperModelInit-283"><span class="linenos">283</span></a>                <span class="n">model</span><span class="o">.</span><span class="n">resize_token_embeddings</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span>
</span><span id="QLoraWrapperModelInit-284"><a href="#QLoraWrapperModelInit-284"><span class="linenos">284</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-285"><a href="#QLoraWrapperModelInit-285"><span class="linenos">285</span></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="QLoraWrapperModelInit-286"><a href="#QLoraWrapperModelInit-286"><span class="linenos">286</span></a>                    <span class="sa">f</span><span class="s2">&quot;Could not resize token embeddings due to </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, but will continue anyway...&quot;</span>
</span><span id="QLoraWrapperModelInit-287"><a href="#QLoraWrapperModelInit-287"><span class="linenos">287</span></a>                <span class="p">)</span>
</span><span id="QLoraWrapperModelInit-288"><a href="#QLoraWrapperModelInit-288"><span class="linenos">288</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-289"><a href="#QLoraWrapperModelInit-289"><span class="linenos">289</span></a>                <span class="n">model</span><span class="o">.</span><span class="n">gradient_checkpointing_enable</span><span class="p">()</span>
</span><span id="QLoraWrapperModelInit-290"><a href="#QLoraWrapperModelInit-290"><span class="linenos">290</span></a>                <span class="n">has_gradient_checkpointing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="QLoraWrapperModelInit-291"><a href="#QLoraWrapperModelInit-291"><span class="linenos">291</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-292"><a href="#QLoraWrapperModelInit-292"><span class="linenos">292</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model checkpointing did not work: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-293"><a href="#QLoraWrapperModelInit-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;LlamaForCausalLM&quot;</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-294"><a href="#QLoraWrapperModelInit-294"><span class="linenos">294</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pretraining_tp</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="QLoraWrapperModelInit-295"><a href="#QLoraWrapperModelInit-295"><span class="linenos">295</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">prepare_model_for_kbit_training</span><span class="p">(</span>
</span><span id="QLoraWrapperModelInit-296"><a href="#QLoraWrapperModelInit-296"><span class="linenos">296</span></a>            <span class="n">model</span><span class="p">,</span> <span class="n">use_gradient_checkpointing</span><span class="o">=</span><span class="n">has_gradient_checkpointing</span>
</span><span id="QLoraWrapperModelInit-297"><a href="#QLoraWrapperModelInit-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="QLoraWrapperModelInit-298"><a href="#QLoraWrapperModelInit-298"><span class="linenos">298</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">get_peft_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">peft_config</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-299"><a href="#QLoraWrapperModelInit-299"><span class="linenos">299</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="QLoraWrapperModelInit-300"><a href="#QLoraWrapperModelInit-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">neftune_noise_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-301"><a href="#QLoraWrapperModelInit-301"><span class="linenos">301</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">activate_neftune</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">neftune_noise_alpha</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-302"><a href="#QLoraWrapperModelInit-302"><span class="linenos">302</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_layer_types_for_stability</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-303"><a href="#QLoraWrapperModelInit-303"><span class="linenos">303</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="QLoraWrapperModelInit-304"><a href="#QLoraWrapperModelInit-304"><span class="linenos">304</span></a>
</span><span id="QLoraWrapperModelInit-305"><a href="#QLoraWrapperModelInit-305"><span class="linenos">305</span></a>    <span class="k">def</span> <span class="nf">change_layer_types_for_stability</span><span class="p">(</span>
</span><span id="QLoraWrapperModelInit-306"><a href="#QLoraWrapperModelInit-306"><span class="linenos">306</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span>
</span><span id="QLoraWrapperModelInit-307"><a href="#QLoraWrapperModelInit-307"><span class="linenos">307</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-308"><a href="#QLoraWrapperModelInit-308"><span class="linenos">308</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit-309"><a href="#QLoraWrapperModelInit-309"><span class="linenos">309</span></a><span class="sd">        Change layer types of the model for stability.</span>
</span><span id="QLoraWrapperModelInit-310"><a href="#QLoraWrapperModelInit-310"><span class="linenos">310</span></a>
</span><span id="QLoraWrapperModelInit-311"><a href="#QLoraWrapperModelInit-311"><span class="linenos">311</span></a><span class="sd">        Parameters</span>
</span><span id="QLoraWrapperModelInit-312"><a href="#QLoraWrapperModelInit-312"><span class="linenos">312</span></a><span class="sd">        ----------</span>
</span><span id="QLoraWrapperModelInit-313"><a href="#QLoraWrapperModelInit-313"><span class="linenos">313</span></a><span class="sd">        model : PreTrainedModel</span>
</span><span id="QLoraWrapperModelInit-314"><a href="#QLoraWrapperModelInit-314"><span class="linenos">314</span></a><span class="sd">            The pre-trained model.</span>
</span><span id="QLoraWrapperModelInit-315"><a href="#QLoraWrapperModelInit-315"><span class="linenos">315</span></a>
</span><span id="QLoraWrapperModelInit-316"><a href="#QLoraWrapperModelInit-316"><span class="linenos">316</span></a><span class="sd">        Returns</span>
</span><span id="QLoraWrapperModelInit-317"><a href="#QLoraWrapperModelInit-317"><span class="linenos">317</span></a><span class="sd">        -------</span>
</span><span id="QLoraWrapperModelInit-318"><a href="#QLoraWrapperModelInit-318"><span class="linenos">318</span></a><span class="sd">        Pre-trained model with modified layer types for stability.</span>
</span><span id="QLoraWrapperModelInit-319"><a href="#QLoraWrapperModelInit-319"><span class="linenos">319</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit-320"><a href="#QLoraWrapperModelInit-320"><span class="linenos">320</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
</span><span id="QLoraWrapperModelInit-321"><a href="#QLoraWrapperModelInit-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">LoraLayer</span><span class="p">):</span>
</span><span id="QLoraWrapperModelInit-322"><a href="#QLoraWrapperModelInit-322"><span class="linenos">322</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-323"><a href="#QLoraWrapperModelInit-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-324"><a href="#QLoraWrapperModelInit-324"><span class="linenos">324</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-325"><a href="#QLoraWrapperModelInit-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="s2">&quot;lm_head&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;embed_tokens&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit-326"><a href="#QLoraWrapperModelInit-326"><span class="linenos">326</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">):</span>
</span><span id="QLoraWrapperModelInit-327"><a href="#QLoraWrapperModelInit-327"><span class="linenos">327</span></a>                    <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit-328"><a href="#QLoraWrapperModelInit-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>A wrapper class for initializing transformer-based models with QLoRa and gradient checkpointing.</p>

<p>This class serves as a wrapper for the <code><a href="#QLoraWrapperModelInit.model_init">model_init</a></code> function, which initializes the model.
It activates gradient checkpointing when possible and applies QLoRa to the model.</p>

<h2 id="parameters">Parameters</h2>

<p>model_init : callable
    A function that initializes the transformer-based model for training.
model_config : Any
    The configuration for the model.
tokenizer : Any
    The tokenizer used for tokenization.</p>

<h2 id="returns">Returns</h2>

<p>Pre-trained model with QLoRa and gradient checkpointing, if enabled.</p>
</div>


                            <div id="QLoraWrapperModelInit.__init__" class="classattr">
                                        <input id="QLoraWrapperModelInit.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">QLoraWrapperModelInit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">model_init</span><span class="p">:</span> <span class="n">Any</span>, </span><span class="param"><span class="n">model_config</span><span class="p">:</span> <span class="n">Any</span>, </span><span class="param"><span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span></span>)</span>

                <label class="view-source-button" for="QLoraWrapperModelInit.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QLoraWrapperModelInit.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QLoraWrapperModelInit.__init__-263"><a href="#QLoraWrapperModelInit.__init__-263"><span class="linenos">263</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_init</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit.__init__-264"><a href="#QLoraWrapperModelInit.__init__-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_init</span> <span class="o">=</span> <span class="n">model_init</span>
</span><span id="QLoraWrapperModelInit.__init__-265"><a href="#QLoraWrapperModelInit.__init__-265"><span class="linenos">265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
</span><span id="QLoraWrapperModelInit.__init__-266"><a href="#QLoraWrapperModelInit.__init__-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</span></pre></div>


    

                            </div>
                            <div id="QLoraWrapperModelInit.model_init" class="classattr">
                                <div class="attr variable">
            <span class="name">model_init</span>

        
    </div>
    <a class="headerlink" href="#QLoraWrapperModelInit.model_init"></a>
    
    

                            </div>
                            <div id="QLoraWrapperModelInit.model_config" class="classattr">
                                <div class="attr variable">
            <span class="name">model_config</span>

        
    </div>
    <a class="headerlink" href="#QLoraWrapperModelInit.model_config"></a>
    
    

                            </div>
                            <div id="QLoraWrapperModelInit.tokenizer" class="classattr">
                                <div class="attr variable">
            <span class="name">tokenizer</span>

        
    </div>
    <a class="headerlink" href="#QLoraWrapperModelInit.tokenizer"></a>
    
    

                            </div>
                            <div id="QLoraWrapperModelInit.change_layer_types_for_stability" class="classattr">
                                        <input id="QLoraWrapperModelInit.change_layer_types_for_stability-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">change_layer_types_for_stability</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">transformers</span><span class="o">.</span><span class="n">modeling_utils</span><span class="o">.</span><span class="n">PreTrainedModel</span></span><span class="return-annotation">) -> <span class="n">transformers</span><span class="o">.</span><span class="n">modeling_utils</span><span class="o">.</span><span class="n">PreTrainedModel</span>:</span></span>

                <label class="view-source-button" for="QLoraWrapperModelInit.change_layer_types_for_stability-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#QLoraWrapperModelInit.change_layer_types_for_stability"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-305"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-305"><span class="linenos">305</span></a>    <span class="k">def</span> <span class="nf">change_layer_types_for_stability</span><span class="p">(</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-306"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-306"><span class="linenos">306</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-307"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-307"><span class="linenos">307</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-308"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-308"><span class="linenos">308</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-309"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-309"><span class="linenos">309</span></a><span class="sd">        Change layer types of the model for stability.</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-310"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-310"><span class="linenos">310</span></a>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-311"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-311"><span class="linenos">311</span></a><span class="sd">        Parameters</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-312"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-312"><span class="linenos">312</span></a><span class="sd">        ----------</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-313"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-313"><span class="linenos">313</span></a><span class="sd">        model : PreTrainedModel</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-314"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-314"><span class="linenos">314</span></a><span class="sd">            The pre-trained model.</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-315"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-315"><span class="linenos">315</span></a>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-316"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-316"><span class="linenos">316</span></a><span class="sd">        Returns</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-317"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-317"><span class="linenos">317</span></a><span class="sd">        -------</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-318"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-318"><span class="linenos">318</span></a><span class="sd">        Pre-trained model with modified layer types for stability.</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-319"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-319"><span class="linenos">319</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-320"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-320"><span class="linenos">320</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-321"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">LoraLayer</span><span class="p">):</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-322"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-322"><span class="linenos">322</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-323"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-324"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-324"><span class="linenos">324</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-325"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="s2">&quot;lm_head&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;embed_tokens&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-326"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-326"><span class="linenos">326</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">):</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-327"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-327"><span class="linenos">327</span></a>                    <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
</span><span id="QLoraWrapperModelInit.change_layer_types_for_stability-328"><a href="#QLoraWrapperModelInit.change_layer_types_for_stability-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Change layer types of the model for stability.</p>

<h2 id="parameters">Parameters</h2>

<p>model : PreTrainedModel
    The pre-trained model.</p>

<h2 id="returns">Returns</h2>

<p>Pre-trained model with modified layer types for stability.</p>
</div>


                            </div>
                </section>
                <section id="modify_tokenizer">
                            <input id="modify_tokenizer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_tokenizer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tokenizer</span><span class="p">:</span> <span class="n">transformers</span><span class="o">.</span><span class="n">tokenization_utils</span><span class="o">.</span><span class="n">PreTrainedTokenizer</span>,</span><span class="param">	<span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">padding_side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">new_model_seq_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">add_special_tokens</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">add_tokens</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">chat_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">transformers</span><span class="o">.</span><span class="n">tokenization_utils</span><span class="o">.</span><span class="n">PreTrainedTokenizer</span>:</span></span>

                <label class="view-source-button" for="modify_tokenizer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#modify_tokenizer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="modify_tokenizer-331"><a href="#modify_tokenizer-331"><span class="linenos">331</span></a><span class="k">def</span> <span class="nf">modify_tokenizer</span><span class="p">(</span>
</span><span id="modify_tokenizer-332"><a href="#modify_tokenizer-332"><span class="linenos">332</span></a>    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span><span class="p">,</span>
</span><span id="modify_tokenizer-333"><a href="#modify_tokenizer-333"><span class="linenos">333</span></a>    <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="modify_tokenizer-334"><a href="#modify_tokenizer-334"><span class="linenos">334</span></a>    <span class="n">padding_side</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="modify_tokenizer-335"><a href="#modify_tokenizer-335"><span class="linenos">335</span></a>    <span class="n">new_model_seq_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="modify_tokenizer-336"><a href="#modify_tokenizer-336"><span class="linenos">336</span></a>    <span class="n">add_special_tokens</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="modify_tokenizer-337"><a href="#modify_tokenizer-337"><span class="linenos">337</span></a>    <span class="n">add_tokens</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="modify_tokenizer-338"><a href="#modify_tokenizer-338"><span class="linenos">338</span></a>    <span class="n">chat_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="modify_tokenizer-339"><a href="#modify_tokenizer-339"><span class="linenos">339</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizer</span><span class="p">:</span>
</span><span id="modify_tokenizer-340"><a href="#modify_tokenizer-340"><span class="linenos">340</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="modify_tokenizer-341"><a href="#modify_tokenizer-341"><span class="linenos">341</span></a><span class="sd">    Modify properties of a pre-trained tokenizer.</span>
</span><span id="modify_tokenizer-342"><a href="#modify_tokenizer-342"><span class="linenos">342</span></a>
</span><span id="modify_tokenizer-343"><a href="#modify_tokenizer-343"><span class="linenos">343</span></a><span class="sd">    This function allows you to modify various properties of a pre-trained tokenizer,</span>
</span><span id="modify_tokenizer-344"><a href="#modify_tokenizer-344"><span class="linenos">344</span></a><span class="sd">    such as the pad_token_id, padding_side, model_max_length, special tokens, and additional tokens.</span>
</span><span id="modify_tokenizer-345"><a href="#modify_tokenizer-345"><span class="linenos">345</span></a>
</span><span id="modify_tokenizer-346"><a href="#modify_tokenizer-346"><span class="linenos">346</span></a><span class="sd">    Parameters</span>
</span><span id="modify_tokenizer-347"><a href="#modify_tokenizer-347"><span class="linenos">347</span></a><span class="sd">    ----------</span>
</span><span id="modify_tokenizer-348"><a href="#modify_tokenizer-348"><span class="linenos">348</span></a><span class="sd">    tokenizer : PreTrainedTokenizer</span>
</span><span id="modify_tokenizer-349"><a href="#modify_tokenizer-349"><span class="linenos">349</span></a><span class="sd">        The pre-trained tokenizer to be modified.</span>
</span><span id="modify_tokenizer-350"><a href="#modify_tokenizer-350"><span class="linenos">350</span></a><span class="sd">    pad_token_id : int, optional (default=None)</span>
</span><span id="modify_tokenizer-351"><a href="#modify_tokenizer-351"><span class="linenos">351</span></a><span class="sd">        The ID of the padding token to set for the tokenizer.</span>
</span><span id="modify_tokenizer-352"><a href="#modify_tokenizer-352"><span class="linenos">352</span></a><span class="sd">    padding_side : str, optional (default=None)</span>
</span><span id="modify_tokenizer-353"><a href="#modify_tokenizer-353"><span class="linenos">353</span></a><span class="sd">        The side (either &#39;left&#39; or &#39;right&#39;) to apply padding.</span>
</span><span id="modify_tokenizer-354"><a href="#modify_tokenizer-354"><span class="linenos">354</span></a><span class="sd">    new_model_seq_length : int, optional (default=None)</span>
</span><span id="modify_tokenizer-355"><a href="#modify_tokenizer-355"><span class="linenos">355</span></a><span class="sd">        The new maximum sequence length allowed by the tokenizer.</span>
</span><span id="modify_tokenizer-356"><a href="#modify_tokenizer-356"><span class="linenos">356</span></a><span class="sd">    add_special_tokens : dict, optional (default=None)</span>
</span><span id="modify_tokenizer-357"><a href="#modify_tokenizer-357"><span class="linenos">357</span></a><span class="sd">        A dictionary specifying special tokens to be added to the tokenizer.</span>
</span><span id="modify_tokenizer-358"><a href="#modify_tokenizer-358"><span class="linenos">358</span></a><span class="sd">    add_tokens : list, optional (default=None)</span>
</span><span id="modify_tokenizer-359"><a href="#modify_tokenizer-359"><span class="linenos">359</span></a><span class="sd">        A list of additional tokens to be added to the tokenizer&#39;s vocabulary.</span>
</span><span id="modify_tokenizer-360"><a href="#modify_tokenizer-360"><span class="linenos">360</span></a><span class="sd">    chat_template : str, optional (default=None)</span>
</span><span id="modify_tokenizer-361"><a href="#modify_tokenizer-361"><span class="linenos">361</span></a><span class="sd">        The chat template to use for the tokenizer.</span>
</span><span id="modify_tokenizer-362"><a href="#modify_tokenizer-362"><span class="linenos">362</span></a>
</span><span id="modify_tokenizer-363"><a href="#modify_tokenizer-363"><span class="linenos">363</span></a><span class="sd">    Returns</span>
</span><span id="modify_tokenizer-364"><a href="#modify_tokenizer-364"><span class="linenos">364</span></a><span class="sd">    -------</span>
</span><span id="modify_tokenizer-365"><a href="#modify_tokenizer-365"><span class="linenos">365</span></a><span class="sd">    PreTrainedTokenizer</span>
</span><span id="modify_tokenizer-366"><a href="#modify_tokenizer-366"><span class="linenos">366</span></a><span class="sd">        The modified pre-trained tokenizer.</span>
</span><span id="modify_tokenizer-367"><a href="#modify_tokenizer-367"><span class="linenos">367</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="modify_tokenizer-368"><a href="#modify_tokenizer-368"><span class="linenos">368</span></a>    <span class="k">if</span> <span class="n">pad_token_id</span><span class="p">:</span>
</span><span id="modify_tokenizer-369"><a href="#modify_tokenizer-369"><span class="linenos">369</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">pad_token_id</span>
</span><span id="modify_tokenizer-370"><a href="#modify_tokenizer-370"><span class="linenos">370</span></a>    <span class="k">if</span> <span class="n">padding_side</span><span class="p">:</span>
</span><span id="modify_tokenizer-371"><a href="#modify_tokenizer-371"><span class="linenos">371</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">=</span> <span class="n">padding_side</span>
</span><span id="modify_tokenizer-372"><a href="#modify_tokenizer-372"><span class="linenos">372</span></a>    <span class="k">if</span> <span class="n">new_model_seq_length</span><span class="p">:</span>
</span><span id="modify_tokenizer-373"><a href="#modify_tokenizer-373"><span class="linenos">373</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">model_max_length</span> <span class="o">=</span> <span class="n">new_model_seq_length</span>
</span><span id="modify_tokenizer-374"><a href="#modify_tokenizer-374"><span class="linenos">374</span></a>    <span class="k">if</span> <span class="n">add_special_tokens</span><span class="p">:</span>
</span><span id="modify_tokenizer-375"><a href="#modify_tokenizer-375"><span class="linenos">375</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">(</span><span class="n">add_special_tokens</span><span class="p">)</span>
</span><span id="modify_tokenizer-376"><a href="#modify_tokenizer-376"><span class="linenos">376</span></a>    <span class="k">if</span> <span class="n">add_tokens</span><span class="p">:</span>
</span><span id="modify_tokenizer-377"><a href="#modify_tokenizer-377"><span class="linenos">377</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">add_tokens</span><span class="p">(</span><span class="n">add_tokens</span><span class="p">)</span>
</span><span id="modify_tokenizer-378"><a href="#modify_tokenizer-378"><span class="linenos">378</span></a>    <span class="k">if</span> <span class="n">chat_template</span><span class="p">:</span>
</span><span id="modify_tokenizer-379"><a href="#modify_tokenizer-379"><span class="linenos">379</span></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="o">=</span> <span class="n">chat_template</span>
</span><span id="modify_tokenizer-380"><a href="#modify_tokenizer-380"><span class="linenos">380</span></a>    <span class="k">return</span> <span class="n">tokenizer</span>
</span></pre></div>


            <div class="docstring"><p>Modify properties of a pre-trained tokenizer.</p>

<p>This function allows you to modify various properties of a pre-trained tokenizer,
such as the pad_token_id, padding_side, model_max_length, special tokens, and additional tokens.</p>

<h2 id="parameters">Parameters</h2>

<p>tokenizer : PreTrainedTokenizer
    The pre-trained tokenizer to be modified.
pad_token_id : int, optional (default=None)
    The ID of the padding token to set for the tokenizer.
padding_side : str, optional (default=None)
    The side (either 'left' or 'right') to apply padding.
new_model_seq_length : int, optional (default=None)
    The new maximum sequence length allowed by the tokenizer.
add_special_tokens : dict, optional (default=None)
    A dictionary specifying special tokens to be added to the tokenizer.
add_tokens : list, optional (default=None)
    A list of additional tokens to be added to the tokenizer's vocabulary.
chat_template : str, optional (default=None)
    The chat template to use for the tokenizer.</p>

<h2 id="returns">Returns</h2>

<p>PreTrainedTokenizer
    The modified pre-trained tokenizer.</p>
</div>


                </section>
                <section id="qlora_config">
                    <div class="attr variable">
            <span class="name">qlora_config</span>        =
<input id="qlora_config-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="qlora_config-view-value"></label><span class="default_value">BitsAndBytesConfig {
  &#34;_load_in_4bit&#34;: true,
  &#34;_load_in_8bit&#34;: false,
  &#34;bnb_4bit_compute_dtype&#34;: &#34;bfloat16&#34;,
  &#34;bnb_4bit_quant_type&#34;: &#34;nf4&#34;,
  &#34;bnb_4bit_use_double_quant&#34;: true,
  &#34;llm_int8_enable_fp32_cpu_offload&#34;: false,
  &#34;llm_int8_has_fp16_weight&#34;: false,
  &#34;llm_int8_skip_modules&#34;: null,
  &#34;llm_int8_threshold&#34;: 6.0,
  &#34;load_in_4bit&#34;: true,
  &#34;load_in_8bit&#34;: false,
  &#34;quant_method&#34;: &#34;bitsandbytes&#34;
}
</span>

        
    </div>
    <a class="headerlink" href="#qlora_config"></a>
    
    

                </section>
                <section id="SavePeftModelCallback">
                            <input id="SavePeftModelCallback-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SavePeftModelCallback</span><wbr>(<span class="base">transformers.trainer_callback.TrainerCallback</span>):

                <label class="view-source-button" for="SavePeftModelCallback-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SavePeftModelCallback"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SavePeftModelCallback-391"><a href="#SavePeftModelCallback-391"><span class="linenos">391</span></a><span class="k">class</span> <span class="nc">SavePeftModelCallback</span><span class="p">(</span><span class="n">TrainerCallback</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-392"><a href="#SavePeftModelCallback-392"><span class="linenos">392</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-393"><a href="#SavePeftModelCallback-393"><span class="linenos">393</span></a><span class="sd">    Callback for saving only adapter layers from PEFT (Parameter Efficient Fine-Tuning) checkpoints.</span>
</span><span id="SavePeftModelCallback-394"><a href="#SavePeftModelCallback-394"><span class="linenos">394</span></a>
</span><span id="SavePeftModelCallback-395"><a href="#SavePeftModelCallback-395"><span class="linenos">395</span></a><span class="sd">    This callback is designed to be applied to the `transformers.Trainer` to save adapter layers</span>
</span><span id="SavePeftModelCallback-396"><a href="#SavePeftModelCallback-396"><span class="linenos">396</span></a><span class="sd">    from PEFT checkpoints instead of saving full model weights.</span>
</span><span id="SavePeftModelCallback-397"><a href="#SavePeftModelCallback-397"><span class="linenos">397</span></a>
</span><span id="SavePeftModelCallback-398"><a href="#SavePeftModelCallback-398"><span class="linenos">398</span></a><span class="sd">    Methods</span>
</span><span id="SavePeftModelCallback-399"><a href="#SavePeftModelCallback-399"><span class="linenos">399</span></a><span class="sd">    -------</span>
</span><span id="SavePeftModelCallback-400"><a href="#SavePeftModelCallback-400"><span class="linenos">400</span></a><span class="sd">    save_model(args, state, kwargs):</span>
</span><span id="SavePeftModelCallback-401"><a href="#SavePeftModelCallback-401"><span class="linenos">401</span></a><span class="sd">        Save the adapter model from the PEFT checkpoint.</span>
</span><span id="SavePeftModelCallback-402"><a href="#SavePeftModelCallback-402"><span class="linenos">402</span></a><span class="sd">    on_save(args, state, control, **kwargs):</span>
</span><span id="SavePeftModelCallback-403"><a href="#SavePeftModelCallback-403"><span class="linenos">403</span></a><span class="sd">        Triggered when saving the model during training. Calls `save_model` and returns control.</span>
</span><span id="SavePeftModelCallback-404"><a href="#SavePeftModelCallback-404"><span class="linenos">404</span></a><span class="sd">    on_train_end(args, state, control, **kwargs):</span>
</span><span id="SavePeftModelCallback-405"><a href="#SavePeftModelCallback-405"><span class="linenos">405</span></a><span class="sd">        Triggered at the end of training. Creates a &#39;completed&#39; file and calls `save_model`.</span>
</span><span id="SavePeftModelCallback-406"><a href="#SavePeftModelCallback-406"><span class="linenos">406</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-407"><a href="#SavePeftModelCallback-407"><span class="linenos">407</span></a>
</span><span id="SavePeftModelCallback-408"><a href="#SavePeftModelCallback-408"><span class="linenos">408</span></a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-409"><a href="#SavePeftModelCallback-409"><span class="linenos">409</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-410"><a href="#SavePeftModelCallback-410"><span class="linenos">410</span></a><span class="sd">        Save the adapter model from the PEFT checkpoint.</span>
</span><span id="SavePeftModelCallback-411"><a href="#SavePeftModelCallback-411"><span class="linenos">411</span></a>
</span><span id="SavePeftModelCallback-412"><a href="#SavePeftModelCallback-412"><span class="linenos">412</span></a><span class="sd">        Parameters</span>
</span><span id="SavePeftModelCallback-413"><a href="#SavePeftModelCallback-413"><span class="linenos">413</span></a><span class="sd">        ----------</span>
</span><span id="SavePeftModelCallback-414"><a href="#SavePeftModelCallback-414"><span class="linenos">414</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="SavePeftModelCallback-415"><a href="#SavePeftModelCallback-415"><span class="linenos">415</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="SavePeftModelCallback-416"><a href="#SavePeftModelCallback-416"><span class="linenos">416</span></a><span class="sd">        state : TrainerState</span>
</span><span id="SavePeftModelCallback-417"><a href="#SavePeftModelCallback-417"><span class="linenos">417</span></a><span class="sd">            Current trainer state.</span>
</span><span id="SavePeftModelCallback-418"><a href="#SavePeftModelCallback-418"><span class="linenos">418</span></a><span class="sd">        kwargs : dict</span>
</span><span id="SavePeftModelCallback-419"><a href="#SavePeftModelCallback-419"><span class="linenos">419</span></a><span class="sd">            Additional keyword arguments, including the model.</span>
</span><span id="SavePeftModelCallback-420"><a href="#SavePeftModelCallback-420"><span class="linenos">420</span></a>
</span><span id="SavePeftModelCallback-421"><a href="#SavePeftModelCallback-421"><span class="linenos">421</span></a><span class="sd">        Returns</span>
</span><span id="SavePeftModelCallback-422"><a href="#SavePeftModelCallback-422"><span class="linenos">422</span></a><span class="sd">        -------</span>
</span><span id="SavePeftModelCallback-423"><a href="#SavePeftModelCallback-423"><span class="linenos">423</span></a><span class="sd">        None</span>
</span><span id="SavePeftModelCallback-424"><a href="#SavePeftModelCallback-424"><span class="linenos">424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-425"><a href="#SavePeftModelCallback-425"><span class="linenos">425</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving PEFT checkpoint...&quot;</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-426"><a href="#SavePeftModelCallback-426"><span class="linenos">426</span></a>        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">best_model_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SavePeftModelCallback-427"><a href="#SavePeftModelCallback-427"><span class="linenos">427</span></a>            <span class="n">checkpoint_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SavePeftModelCallback-428"><a href="#SavePeftModelCallback-428"><span class="linenos">428</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">best_model_checkpoint</span><span class="p">,</span> <span class="s2">&quot;adapter_model&quot;</span>
</span><span id="SavePeftModelCallback-429"><a href="#SavePeftModelCallback-429"><span class="linenos">429</span></a>            <span class="p">)</span>
</span><span id="SavePeftModelCallback-430"><a href="#SavePeftModelCallback-430"><span class="linenos">430</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SavePeftModelCallback-431"><a href="#SavePeftModelCallback-431"><span class="linenos">431</span></a>            <span class="n">checkpoint_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SavePeftModelCallback-432"><a href="#SavePeftModelCallback-432"><span class="linenos">432</span></a>                <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PREFIX_CHECKPOINT_DIR</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SavePeftModelCallback-433"><a href="#SavePeftModelCallback-433"><span class="linenos">433</span></a>            <span class="p">)</span>
</span><span id="SavePeftModelCallback-434"><a href="#SavePeftModelCallback-434"><span class="linenos">434</span></a>
</span><span id="SavePeftModelCallback-435"><a href="#SavePeftModelCallback-435"><span class="linenos">435</span></a>        <span class="n">peft_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_folder</span><span class="p">,</span> <span class="s2">&quot;adapter_model&quot;</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-436"><a href="#SavePeftModelCallback-436"><span class="linenos">436</span></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">peft_model_path</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-437"><a href="#SavePeftModelCallback-437"><span class="linenos">437</span></a>
</span><span id="SavePeftModelCallback-438"><a href="#SavePeftModelCallback-438"><span class="linenos">438</span></a>        <span class="n">pytorch_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_folder</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-439"><a href="#SavePeftModelCallback-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pytorch_model_path</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-440"><a href="#SavePeftModelCallback-440"><span class="linenos">440</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pytorch_model_path</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-441"><a href="#SavePeftModelCallback-441"><span class="linenos">441</span></a>
</span><span id="SavePeftModelCallback-442"><a href="#SavePeftModelCallback-442"><span class="linenos">442</span></a>    <span class="k">def</span> <span class="nf">on_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-443"><a href="#SavePeftModelCallback-443"><span class="linenos">443</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-444"><a href="#SavePeftModelCallback-444"><span class="linenos">444</span></a><span class="sd">        Triggered when saving the model during training. Calls `save_model` and returns control.</span>
</span><span id="SavePeftModelCallback-445"><a href="#SavePeftModelCallback-445"><span class="linenos">445</span></a>
</span><span id="SavePeftModelCallback-446"><a href="#SavePeftModelCallback-446"><span class="linenos">446</span></a><span class="sd">        Parameters</span>
</span><span id="SavePeftModelCallback-447"><a href="#SavePeftModelCallback-447"><span class="linenos">447</span></a><span class="sd">        ----------</span>
</span><span id="SavePeftModelCallback-448"><a href="#SavePeftModelCallback-448"><span class="linenos">448</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="SavePeftModelCallback-449"><a href="#SavePeftModelCallback-449"><span class="linenos">449</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="SavePeftModelCallback-450"><a href="#SavePeftModelCallback-450"><span class="linenos">450</span></a><span class="sd">        state : TrainerState</span>
</span><span id="SavePeftModelCallback-451"><a href="#SavePeftModelCallback-451"><span class="linenos">451</span></a><span class="sd">            Current trainer state.</span>
</span><span id="SavePeftModelCallback-452"><a href="#SavePeftModelCallback-452"><span class="linenos">452</span></a><span class="sd">        control : str</span>
</span><span id="SavePeftModelCallback-453"><a href="#SavePeftModelCallback-453"><span class="linenos">453</span></a><span class="sd">            Control string for trainer callback.</span>
</span><span id="SavePeftModelCallback-454"><a href="#SavePeftModelCallback-454"><span class="linenos">454</span></a><span class="sd">        kwargs : dict</span>
</span><span id="SavePeftModelCallback-455"><a href="#SavePeftModelCallback-455"><span class="linenos">455</span></a><span class="sd">            Additional keyword arguments.</span>
</span><span id="SavePeftModelCallback-456"><a href="#SavePeftModelCallback-456"><span class="linenos">456</span></a>
</span><span id="SavePeftModelCallback-457"><a href="#SavePeftModelCallback-457"><span class="linenos">457</span></a><span class="sd">        Returns</span>
</span><span id="SavePeftModelCallback-458"><a href="#SavePeftModelCallback-458"><span class="linenos">458</span></a><span class="sd">        -------</span>
</span><span id="SavePeftModelCallback-459"><a href="#SavePeftModelCallback-459"><span class="linenos">459</span></a><span class="sd">        str</span>
</span><span id="SavePeftModelCallback-460"><a href="#SavePeftModelCallback-460"><span class="linenos">460</span></a><span class="sd">            Control string.</span>
</span><span id="SavePeftModelCallback-461"><a href="#SavePeftModelCallback-461"><span class="linenos">461</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-462"><a href="#SavePeftModelCallback-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-463"><a href="#SavePeftModelCallback-463"><span class="linenos">463</span></a>        <span class="k">return</span> <span class="n">control</span>
</span><span id="SavePeftModelCallback-464"><a href="#SavePeftModelCallback-464"><span class="linenos">464</span></a>
</span><span id="SavePeftModelCallback-465"><a href="#SavePeftModelCallback-465"><span class="linenos">465</span></a>    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-466"><a href="#SavePeftModelCallback-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-467"><a href="#SavePeftModelCallback-467"><span class="linenos">467</span></a><span class="sd">        Triggered at the end of training. Creates a &#39;completed&#39; file and calls `save_model`.</span>
</span><span id="SavePeftModelCallback-468"><a href="#SavePeftModelCallback-468"><span class="linenos">468</span></a>
</span><span id="SavePeftModelCallback-469"><a href="#SavePeftModelCallback-469"><span class="linenos">469</span></a><span class="sd">        Parameters</span>
</span><span id="SavePeftModelCallback-470"><a href="#SavePeftModelCallback-470"><span class="linenos">470</span></a><span class="sd">        ----------</span>
</span><span id="SavePeftModelCallback-471"><a href="#SavePeftModelCallback-471"><span class="linenos">471</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="SavePeftModelCallback-472"><a href="#SavePeftModelCallback-472"><span class="linenos">472</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="SavePeftModelCallback-473"><a href="#SavePeftModelCallback-473"><span class="linenos">473</span></a><span class="sd">        state : TrainerState</span>
</span><span id="SavePeftModelCallback-474"><a href="#SavePeftModelCallback-474"><span class="linenos">474</span></a><span class="sd">            Current trainer state.</span>
</span><span id="SavePeftModelCallback-475"><a href="#SavePeftModelCallback-475"><span class="linenos">475</span></a><span class="sd">        control : str</span>
</span><span id="SavePeftModelCallback-476"><a href="#SavePeftModelCallback-476"><span class="linenos">476</span></a><span class="sd">            Control string for trainer callback.</span>
</span><span id="SavePeftModelCallback-477"><a href="#SavePeftModelCallback-477"><span class="linenos">477</span></a><span class="sd">        kwargs : dict</span>
</span><span id="SavePeftModelCallback-478"><a href="#SavePeftModelCallback-478"><span class="linenos">478</span></a><span class="sd">            Additional keyword arguments.</span>
</span><span id="SavePeftModelCallback-479"><a href="#SavePeftModelCallback-479"><span class="linenos">479</span></a>
</span><span id="SavePeftModelCallback-480"><a href="#SavePeftModelCallback-480"><span class="linenos">480</span></a><span class="sd">        Returns</span>
</span><span id="SavePeftModelCallback-481"><a href="#SavePeftModelCallback-481"><span class="linenos">481</span></a><span class="sd">        -------</span>
</span><span id="SavePeftModelCallback-482"><a href="#SavePeftModelCallback-482"><span class="linenos">482</span></a><span class="sd">        None</span>
</span><span id="SavePeftModelCallback-483"><a href="#SavePeftModelCallback-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback-484"><a href="#SavePeftModelCallback-484"><span class="linenos">484</span></a>
</span><span id="SavePeftModelCallback-485"><a href="#SavePeftModelCallback-485"><span class="linenos">485</span></a>        <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-486"><a href="#SavePeftModelCallback-486"><span class="linenos">486</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">):</span>
</span><span id="SavePeftModelCallback-487"><a href="#SavePeftModelCallback-487"><span class="linenos">487</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
</span><span id="SavePeftModelCallback-488"><a href="#SavePeftModelCallback-488"><span class="linenos">488</span></a>
</span><span id="SavePeftModelCallback-489"><a href="#SavePeftModelCallback-489"><span class="linenos">489</span></a>        <span class="n">touch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">))</span>
</span><span id="SavePeftModelCallback-490"><a href="#SavePeftModelCallback-490"><span class="linenos">490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Callback for saving only adapter layers from PEFT (Parameter Efficient Fine-Tuning) checkpoints.</p>

<p>This callback is designed to be applied to the <code>transformers.Trainer</code> to save adapter layers
from PEFT checkpoints instead of saving full model weights.</p>

<h2 id="methods">Methods</h2>

<p>save_model(args, state, kwargs):
    Save the adapter model from the PEFT checkpoint.
on_save(args, state, control, <em>*kwargs):
    Triggered when saving the model during training. Calls <code><a href="#SavePeftModelCallback.save_model">save_model</a></code> and returns control.
on_train_end(args, state, control, *</em>kwargs):
    Triggered at the end of training. Creates a 'completed' file and calls <code><a href="#SavePeftModelCallback.save_model">save_model</a></code>.</p>
</div>


                            <div id="SavePeftModelCallback.save_model" class="classattr">
                                        <input id="SavePeftModelCallback.save_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">args</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SavePeftModelCallback.save_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SavePeftModelCallback.save_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SavePeftModelCallback.save_model-408"><a href="#SavePeftModelCallback.save_model-408"><span class="linenos">408</span></a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="SavePeftModelCallback.save_model-409"><a href="#SavePeftModelCallback.save_model-409"><span class="linenos">409</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback.save_model-410"><a href="#SavePeftModelCallback.save_model-410"><span class="linenos">410</span></a><span class="sd">        Save the adapter model from the PEFT checkpoint.</span>
</span><span id="SavePeftModelCallback.save_model-411"><a href="#SavePeftModelCallback.save_model-411"><span class="linenos">411</span></a>
</span><span id="SavePeftModelCallback.save_model-412"><a href="#SavePeftModelCallback.save_model-412"><span class="linenos">412</span></a><span class="sd">        Parameters</span>
</span><span id="SavePeftModelCallback.save_model-413"><a href="#SavePeftModelCallback.save_model-413"><span class="linenos">413</span></a><span class="sd">        ----------</span>
</span><span id="SavePeftModelCallback.save_model-414"><a href="#SavePeftModelCallback.save_model-414"><span class="linenos">414</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="SavePeftModelCallback.save_model-415"><a href="#SavePeftModelCallback.save_model-415"><span class="linenos">415</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="SavePeftModelCallback.save_model-416"><a href="#SavePeftModelCallback.save_model-416"><span class="linenos">416</span></a><span class="sd">        state : TrainerState</span>
</span><span id="SavePeftModelCallback.save_model-417"><a href="#SavePeftModelCallback.save_model-417"><span class="linenos">417</span></a><span class="sd">            Current trainer state.</span>
</span><span id="SavePeftModelCallback.save_model-418"><a href="#SavePeftModelCallback.save_model-418"><span class="linenos">418</span></a><span class="sd">        kwargs : dict</span>
</span><span id="SavePeftModelCallback.save_model-419"><a href="#SavePeftModelCallback.save_model-419"><span class="linenos">419</span></a><span class="sd">            Additional keyword arguments, including the model.</span>
</span><span id="SavePeftModelCallback.save_model-420"><a href="#SavePeftModelCallback.save_model-420"><span class="linenos">420</span></a>
</span><span id="SavePeftModelCallback.save_model-421"><a href="#SavePeftModelCallback.save_model-421"><span class="linenos">421</span></a><span class="sd">        Returns</span>
</span><span id="SavePeftModelCallback.save_model-422"><a href="#SavePeftModelCallback.save_model-422"><span class="linenos">422</span></a><span class="sd">        -------</span>
</span><span id="SavePeftModelCallback.save_model-423"><a href="#SavePeftModelCallback.save_model-423"><span class="linenos">423</span></a><span class="sd">        None</span>
</span><span id="SavePeftModelCallback.save_model-424"><a href="#SavePeftModelCallback.save_model-424"><span class="linenos">424</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback.save_model-425"><a href="#SavePeftModelCallback.save_model-425"><span class="linenos">425</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving PEFT checkpoint...&quot;</span><span class="p">)</span>
</span><span id="SavePeftModelCallback.save_model-426"><a href="#SavePeftModelCallback.save_model-426"><span class="linenos">426</span></a>        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">best_model_checkpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SavePeftModelCallback.save_model-427"><a href="#SavePeftModelCallback.save_model-427"><span class="linenos">427</span></a>            <span class="n">checkpoint_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SavePeftModelCallback.save_model-428"><a href="#SavePeftModelCallback.save_model-428"><span class="linenos">428</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">best_model_checkpoint</span><span class="p">,</span> <span class="s2">&quot;adapter_model&quot;</span>
</span><span id="SavePeftModelCallback.save_model-429"><a href="#SavePeftModelCallback.save_model-429"><span class="linenos">429</span></a>            <span class="p">)</span>
</span><span id="SavePeftModelCallback.save_model-430"><a href="#SavePeftModelCallback.save_model-430"><span class="linenos">430</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SavePeftModelCallback.save_model-431"><a href="#SavePeftModelCallback.save_model-431"><span class="linenos">431</span></a>            <span class="n">checkpoint_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="SavePeftModelCallback.save_model-432"><a href="#SavePeftModelCallback.save_model-432"><span class="linenos">432</span></a>                <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PREFIX_CHECKPOINT_DIR</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="SavePeftModelCallback.save_model-433"><a href="#SavePeftModelCallback.save_model-433"><span class="linenos">433</span></a>            <span class="p">)</span>
</span><span id="SavePeftModelCallback.save_model-434"><a href="#SavePeftModelCallback.save_model-434"><span class="linenos">434</span></a>
</span><span id="SavePeftModelCallback.save_model-435"><a href="#SavePeftModelCallback.save_model-435"><span class="linenos">435</span></a>        <span class="n">peft_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_folder</span><span class="p">,</span> <span class="s2">&quot;adapter_model&quot;</span><span class="p">)</span>
</span><span id="SavePeftModelCallback.save_model-436"><a href="#SavePeftModelCallback.save_model-436"><span class="linenos">436</span></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">save_pretrained</span><span class="p">(</span><span class="n">peft_model_path</span><span class="p">)</span>
</span><span id="SavePeftModelCallback.save_model-437"><a href="#SavePeftModelCallback.save_model-437"><span class="linenos">437</span></a>
</span><span id="SavePeftModelCallback.save_model-438"><a href="#SavePeftModelCallback.save_model-438"><span class="linenos">438</span></a>        <span class="n">pytorch_model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_folder</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">)</span>
</span><span id="SavePeftModelCallback.save_model-439"><a href="#SavePeftModelCallback.save_model-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pytorch_model_path</span><span class="p">):</span>
</span><span id="SavePeftModelCallback.save_model-440"><a href="#SavePeftModelCallback.save_model-440"><span class="linenos">440</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pytorch_model_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the adapter model from the PEFT checkpoint.</p>

<h2 id="parameters">Parameters</h2>

<p>args : TrainerArguments
    Arguments for the trainer.
state : TrainerState
    Current trainer state.
kwargs : dict
    Additional keyword arguments, including the model.</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="SavePeftModelCallback.on_save" class="classattr">
                                        <input id="SavePeftModelCallback.on_save-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_save</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">args</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">control</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SavePeftModelCallback.on_save-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SavePeftModelCallback.on_save"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SavePeftModelCallback.on_save-442"><a href="#SavePeftModelCallback.on_save-442"><span class="linenos">442</span></a>    <span class="k">def</span> <span class="nf">on_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="SavePeftModelCallback.on_save-443"><a href="#SavePeftModelCallback.on_save-443"><span class="linenos">443</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback.on_save-444"><a href="#SavePeftModelCallback.on_save-444"><span class="linenos">444</span></a><span class="sd">        Triggered when saving the model during training. Calls `save_model` and returns control.</span>
</span><span id="SavePeftModelCallback.on_save-445"><a href="#SavePeftModelCallback.on_save-445"><span class="linenos">445</span></a>
</span><span id="SavePeftModelCallback.on_save-446"><a href="#SavePeftModelCallback.on_save-446"><span class="linenos">446</span></a><span class="sd">        Parameters</span>
</span><span id="SavePeftModelCallback.on_save-447"><a href="#SavePeftModelCallback.on_save-447"><span class="linenos">447</span></a><span class="sd">        ----------</span>
</span><span id="SavePeftModelCallback.on_save-448"><a href="#SavePeftModelCallback.on_save-448"><span class="linenos">448</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="SavePeftModelCallback.on_save-449"><a href="#SavePeftModelCallback.on_save-449"><span class="linenos">449</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="SavePeftModelCallback.on_save-450"><a href="#SavePeftModelCallback.on_save-450"><span class="linenos">450</span></a><span class="sd">        state : TrainerState</span>
</span><span id="SavePeftModelCallback.on_save-451"><a href="#SavePeftModelCallback.on_save-451"><span class="linenos">451</span></a><span class="sd">            Current trainer state.</span>
</span><span id="SavePeftModelCallback.on_save-452"><a href="#SavePeftModelCallback.on_save-452"><span class="linenos">452</span></a><span class="sd">        control : str</span>
</span><span id="SavePeftModelCallback.on_save-453"><a href="#SavePeftModelCallback.on_save-453"><span class="linenos">453</span></a><span class="sd">            Control string for trainer callback.</span>
</span><span id="SavePeftModelCallback.on_save-454"><a href="#SavePeftModelCallback.on_save-454"><span class="linenos">454</span></a><span class="sd">        kwargs : dict</span>
</span><span id="SavePeftModelCallback.on_save-455"><a href="#SavePeftModelCallback.on_save-455"><span class="linenos">455</span></a><span class="sd">            Additional keyword arguments.</span>
</span><span id="SavePeftModelCallback.on_save-456"><a href="#SavePeftModelCallback.on_save-456"><span class="linenos">456</span></a>
</span><span id="SavePeftModelCallback.on_save-457"><a href="#SavePeftModelCallback.on_save-457"><span class="linenos">457</span></a><span class="sd">        Returns</span>
</span><span id="SavePeftModelCallback.on_save-458"><a href="#SavePeftModelCallback.on_save-458"><span class="linenos">458</span></a><span class="sd">        -------</span>
</span><span id="SavePeftModelCallback.on_save-459"><a href="#SavePeftModelCallback.on_save-459"><span class="linenos">459</span></a><span class="sd">        str</span>
</span><span id="SavePeftModelCallback.on_save-460"><a href="#SavePeftModelCallback.on_save-460"><span class="linenos">460</span></a><span class="sd">            Control string.</span>
</span><span id="SavePeftModelCallback.on_save-461"><a href="#SavePeftModelCallback.on_save-461"><span class="linenos">461</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback.on_save-462"><a href="#SavePeftModelCallback.on_save-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="SavePeftModelCallback.on_save-463"><a href="#SavePeftModelCallback.on_save-463"><span class="linenos">463</span></a>        <span class="k">return</span> <span class="n">control</span>
</span></pre></div>


            <div class="docstring"><p>Triggered when saving the model during training. Calls <code><a href="#SavePeftModelCallback.save_model">save_model</a></code> and returns control.</p>

<h2 id="parameters">Parameters</h2>

<p>args : TrainerArguments
    Arguments for the trainer.
state : TrainerState
    Current trainer state.
control : str
    Control string for trainer callback.
kwargs : dict
    Additional keyword arguments.</p>

<h2 id="returns">Returns</h2>

<p>str
    Control string.</p>
</div>


                            </div>
                            <div id="SavePeftModelCallback.on_train_end" class="classattr">
                                        <input id="SavePeftModelCallback.on_train_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_end</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">args</span>, </span><span class="param"><span class="n">state</span>, </span><span class="param"><span class="n">control</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SavePeftModelCallback.on_train_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SavePeftModelCallback.on_train_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SavePeftModelCallback.on_train_end-465"><a href="#SavePeftModelCallback.on_train_end-465"><span class="linenos">465</span></a>    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="SavePeftModelCallback.on_train_end-466"><a href="#SavePeftModelCallback.on_train_end-466"><span class="linenos">466</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback.on_train_end-467"><a href="#SavePeftModelCallback.on_train_end-467"><span class="linenos">467</span></a><span class="sd">        Triggered at the end of training. Creates a &#39;completed&#39; file and calls `save_model`.</span>
</span><span id="SavePeftModelCallback.on_train_end-468"><a href="#SavePeftModelCallback.on_train_end-468"><span class="linenos">468</span></a>
</span><span id="SavePeftModelCallback.on_train_end-469"><a href="#SavePeftModelCallback.on_train_end-469"><span class="linenos">469</span></a><span class="sd">        Parameters</span>
</span><span id="SavePeftModelCallback.on_train_end-470"><a href="#SavePeftModelCallback.on_train_end-470"><span class="linenos">470</span></a><span class="sd">        ----------</span>
</span><span id="SavePeftModelCallback.on_train_end-471"><a href="#SavePeftModelCallback.on_train_end-471"><span class="linenos">471</span></a><span class="sd">        args : TrainerArguments</span>
</span><span id="SavePeftModelCallback.on_train_end-472"><a href="#SavePeftModelCallback.on_train_end-472"><span class="linenos">472</span></a><span class="sd">            Arguments for the trainer.</span>
</span><span id="SavePeftModelCallback.on_train_end-473"><a href="#SavePeftModelCallback.on_train_end-473"><span class="linenos">473</span></a><span class="sd">        state : TrainerState</span>
</span><span id="SavePeftModelCallback.on_train_end-474"><a href="#SavePeftModelCallback.on_train_end-474"><span class="linenos">474</span></a><span class="sd">            Current trainer state.</span>
</span><span id="SavePeftModelCallback.on_train_end-475"><a href="#SavePeftModelCallback.on_train_end-475"><span class="linenos">475</span></a><span class="sd">        control : str</span>
</span><span id="SavePeftModelCallback.on_train_end-476"><a href="#SavePeftModelCallback.on_train_end-476"><span class="linenos">476</span></a><span class="sd">            Control string for trainer callback.</span>
</span><span id="SavePeftModelCallback.on_train_end-477"><a href="#SavePeftModelCallback.on_train_end-477"><span class="linenos">477</span></a><span class="sd">        kwargs : dict</span>
</span><span id="SavePeftModelCallback.on_train_end-478"><a href="#SavePeftModelCallback.on_train_end-478"><span class="linenos">478</span></a><span class="sd">            Additional keyword arguments.</span>
</span><span id="SavePeftModelCallback.on_train_end-479"><a href="#SavePeftModelCallback.on_train_end-479"><span class="linenos">479</span></a>
</span><span id="SavePeftModelCallback.on_train_end-480"><a href="#SavePeftModelCallback.on_train_end-480"><span class="linenos">480</span></a><span class="sd">        Returns</span>
</span><span id="SavePeftModelCallback.on_train_end-481"><a href="#SavePeftModelCallback.on_train_end-481"><span class="linenos">481</span></a><span class="sd">        -------</span>
</span><span id="SavePeftModelCallback.on_train_end-482"><a href="#SavePeftModelCallback.on_train_end-482"><span class="linenos">482</span></a><span class="sd">        None</span>
</span><span id="SavePeftModelCallback.on_train_end-483"><a href="#SavePeftModelCallback.on_train_end-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SavePeftModelCallback.on_train_end-484"><a href="#SavePeftModelCallback.on_train_end-484"><span class="linenos">484</span></a>
</span><span id="SavePeftModelCallback.on_train_end-485"><a href="#SavePeftModelCallback.on_train_end-485"><span class="linenos">485</span></a>        <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SavePeftModelCallback.on_train_end-486"><a href="#SavePeftModelCallback.on_train_end-486"><span class="linenos">486</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">):</span>
</span><span id="SavePeftModelCallback.on_train_end-487"><a href="#SavePeftModelCallback.on_train_end-487"><span class="linenos">487</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
</span><span id="SavePeftModelCallback.on_train_end-488"><a href="#SavePeftModelCallback.on_train_end-488"><span class="linenos">488</span></a>
</span><span id="SavePeftModelCallback.on_train_end-489"><a href="#SavePeftModelCallback.on_train_end-489"><span class="linenos">489</span></a>        <span class="n">touch</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">))</span>
</span><span id="SavePeftModelCallback.on_train_end-490"><a href="#SavePeftModelCallback.on_train_end-490"><span class="linenos">490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Triggered at the end of training. Creates a 'completed' file and calls <code><a href="#SavePeftModelCallback.save_model">save_model</a></code>.</p>

<h2 id="parameters">Parameters</h2>

<p>args : TrainerArguments
    Arguments for the trainer.
state : TrainerState
    Current trainer state.
control : str
    Control string for trainer callback.
kwargs : dict
    Additional keyword arguments.</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>transformers.trainer_callback.TrainerCallback</dt>
                                <dd id="SavePeftModelCallback.on_init_end" class="function">on_init_end</dd>
                <dd id="SavePeftModelCallback.on_train_begin" class="function">on_train_begin</dd>
                <dd id="SavePeftModelCallback.on_epoch_begin" class="function">on_epoch_begin</dd>
                <dd id="SavePeftModelCallback.on_epoch_end" class="function">on_epoch_end</dd>
                <dd id="SavePeftModelCallback.on_step_begin" class="function">on_step_begin</dd>
                <dd id="SavePeftModelCallback.on_substep_end" class="function">on_substep_end</dd>
                <dd id="SavePeftModelCallback.on_step_end" class="function">on_step_end</dd>
                <dd id="SavePeftModelCallback.on_evaluate" class="function">on_evaluate</dd>
                <dd id="SavePeftModelCallback.on_predict" class="function">on_predict</dd>
                <dd id="SavePeftModelCallback.on_log" class="function">on_log</dd>
                <dd id="SavePeftModelCallback.on_prediction_step" class="function">on_prediction_step</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>